# 【工具篇】 常用工具介绍

### javap：查阅 Java 字节码

```
javap的基本用法
  -help  --help  -?        输出此用法消息
  -version                 版本信息
  -v  -verbose             输出附加信息
  -l                       输出行号和本地变量表
  -public                  仅显示公共类和成员
  -protected               显示受保护的/公共类和成员
  -package                 显示程序包/受保护的/公共类
                           和成员 (默认)
  -p  -private             显示所有类和成员
  -c                       对代码进行反汇编
  -s                       输出内部类型签名
  -sysinfo                 显示正在处理的类的
                           系统信息 (路径, 大小, 日期, MD5 散列)
  -constants               显示最终常量
  -classpath <path>        指定查找用户类文件的位置
  -cp <path>               指定查找用户类文件的位置
  -bootclasspath <path>    覆盖引导类文件的位置

```

javap -v选项的输出 (open jdk 10)

1. 基本信息，涵盖了原 class 文件的相关信息。

   ```
   public class Foo 
     //class 文件中的版本号
     minor version: 0					
     major version: 54
     //该类访问权限
     flags: (0x0021) ACC_PUBLIC, ACC_SUPER
     //该类与父类的名称
     this_class: #7                          // Foo
     super_class: #8                         // java/lang/Object
     //实现接口,字段,方法与属性的数目
     interfaces: 0, fields: 4, methods: 2, attributes: 1
   ```

2. 常量池,用来存放各种常量池以及符号引用

   ```
   Constant pool:
      #1 = Methodref          #8.#23         // java/lang/Object."<init>":()V
   ... 
      #8 = Class              #30            // java/lang/Object
   ...
     #14 = Utf8               <init>
     #15 = Utf8               ()V
   ...
     #23 = NameAndType        #14:#15        // "<init>":()V
   ...
     #30 = Utf8               java/lang/Object
   ```

   如果将常量 #1看做树形结构的话

   ![image-20211209142215285](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20211209142215285.png) 

3. 字段区域,用来列举该类中的各个字段

    ```
     private static final int ALIVE_OBJECT_SIZE;
     	//该字段类型
        descriptor: I
        //访问权限
        flags: ACC_PRIVATE, ACC_STATIC, ACC_FINAL
        //对于final static 字段,如果是基本类型或者string类型,则还包含他的常量值
        ConstantValue: int 33554432
    ```

4. 方法区域,用来列举该类中的各个方法

    ```
    public void test();
    	//方法类型
        descriptor: ()V
        //访问权限
        flags: (0x0001) ACC_PUBLIC
        Code:
         //操作数栈  局部变量数目(字节码中而不是程序中) 该方法接受参数的个数
          stack=2, locals=3, args_size=1
          	//字节码,前面是对应的偏移量(bytecode index,BCI)
             0: aload_0
    ...
            10: goto          35
    ...
            34: athrow
            35: aload_0
    ...
            40: return
          //异常表: 每个异常处理器的监控范围 ,异常处理器的起始位置, 异常类型; any代替任意异常类型  
          Exception table:
             from    to  target type
                 0     5    13   Class java/lang/Exception
                 0     5    27   any
                13    19    27   any
          //行数表,Java源程序到字节码偏移量的映射      
          LineNumberTable:
            line 9: 0
    ...
            line 16: 40
          //局部变量表 局部变量的名称,类型和作用域  
          LocalVariableTable:
           //start 指第一次分配的字节码指令 length是此变量可见的字节码字节数 slot指index
            Start  Length  Slot  Name   Signature
               11      29     3     i   J
                0      41     0  args   [Ljava/lang/String;
                3      38     1 length   I
                9      32     2 array   [Lcom/example/demo/ObjectOf64Bytes;  
          StackMapTable: number_of_entries = 3
            frame_type = 77 /* same_locals_1_stack_item */
              stack = [ class java/lang/Exception ]
    ...
    ```

    

### 其他工具

 OpenJDK 项目 [Code Tools](http://openjdk.java.net/projects/code-tools/)：实用小工具集

 ASM：Java 字节码框架