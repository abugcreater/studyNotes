# 23 | 逃逸分析

###  逃逸分析

**逃逸分析**是一种确定[指针](https://zh.wikipedia.org/wiki/指標_(電腦科學))动态范围的方法——分析在程序的哪些地方可以访问到指针。它涉及到指针分析和形状分析。

在Java虚拟机的即时编译语境下,逃逸分析判断**新建**的对象是否**逃逸**,依据是,一对象是否被存入堆中(静态字段或者堆中对象的实例字段)所有线程共享堆对象,二是对象是否被传入位置代码中(未被内联的方法)

### 基于逃逸分析的优化

即时编译器可以根据逃逸分析的结果进行诸如锁消除、栈上分配以及标量替换的优化。

锁消除:如果能够证明锁对象不逃逸,那即时编译器可以消除对该不逃逸对象的加锁,解锁操作.逃逸分析的结果更多用于将新建对象转换在栈上分配或者标量(仅能存一个值的变量)替换.

如果逃逸分析能够证明某些新建的对象不逃逸，那么 Java 虚拟机完全可以将其分配至栈上，并且在 new 语句所在的方法退出时，通过弹出当前方法的栈桢来自动回收所分配的内存空间。这样一来，我们便无须借助垃圾回收器来处理不再被引用的对象。

标量替换这项优化技术，可以看成将原本对对象的字段的访问，替换为一个个局部变量的访问。

### 部分逃逸分析

部分逃逸分析将根据控制流信息，判断出新建对象仅在部分分支中逃逸，并且将对象的新建操作推延至对象逃逸的分支中。这将使得原本因对象逃逸而无法避免的新建对象操作，不再出现在只执行 if-else 分支的程序路径之中。