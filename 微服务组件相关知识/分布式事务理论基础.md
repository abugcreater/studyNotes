# 分布式事务理论基础

分布式事务相关的协议有2PC、3PC。由于`三阶段提交协议3PC`非常难实现，目前市面主流的分布式事务解决方案都是2PC协议。

TCC（Try-Confirm-Cancel） 实际上是服务化的两阶段提交协议.第一阶段try，第二阶段完成confirm或cancel.

## 2PC两阶段提交协议

2PC划分出了事务参与者和协调者的角色,并将过程分为两个阶段.

第一阶段:所有事务参与者预提交,协调者收到所有参与者的预提交进入第二步;否则结束事务

第二阶段:所有事务预提交各自结果后,由协调者决定事务最终是成功还是失败

**二阶段提交的缺点**

1. 参与节点占用公共资源时会导致其他节点阻塞
2. 有一个参与者失败或超市都会导致整个事务失败
3. 协调者发生故障,会导致整个事务一直阻塞下去
4. 无法解决的问题:：协调者再发出commit消息之后宕机，而唯一接收到这条消息的参与者同时也宕机了。那么即使协调者通过选举协议产生了新的协调者，这条事务的状态也是不确定的，没人知道事务是否被已经提交。

## 三阶段提交协议 3PC

三阶段提交中在协调者和参与者中都引入了超时机制.在一阶段和两阶段中插入准备阶段,保证个参与节点状态一致.

**1. CanCommit阶段**

1. 事务询问 协调者向参与者发送CanCommit请求,询问是否可以执行事务操作

2. 参与者收到请求后反馈

**2. PreCommit阶段**

协调者根据参与者的反应情况来决定是否可以继续事务的PreCommit操作,存在以下两种可能.

- **所有参与者都是Yes**
  1. 协调者发送PreCommit请求,进入prepared阶段
  2. 参与者收到请求执行事务操作,记录undo和redo信息
  3. 如果参与者执行成功返回ACK响应
- **有参与者发送NO响应**
  1. 发送中断请求,协调者向所有参与者发送abort请求
  2. 中断事务,参与者收到请求后执行事务中断



**3. doCommit阶段**

**3.1 执行提交**

1. 发送提交请求,整体事务状态从预提交进入提交状态,向参与者发送请求
2. 参与者收到请求后,执行事务提交,并释放资源
3. 提交完成向协调者发生Ack响应
4. 协调者接受到所有参与者响应后完成事务

**3.2 中断事务**

	1. 发送中断请求
 	2. 参与者接受到请求后,利用二阶段的undo信息回滚操作,并释放事务
 	3. 向协调者反馈结果
 	4.  协调者接收到参与者反馈的ACK消息之后，执行事务的中断



参考:[分布式事务的4种模式](https://zhuanlan.zhihu.com/p/78599954)