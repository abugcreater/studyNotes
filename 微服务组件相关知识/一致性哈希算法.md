# 一致性哈希算法

当数据太大而无法存储在一个节点或机器上时，问题变得更加有趣，系统中需要多个这样的节点或机器来存储它.确定哪个key存储,最简单的方式是使用哈希取模确定.先对key进行哈希,然后除以节点数量,确定存放在那个点.

> node_number = hash(key) % N # 其中 N 为节点数。

## 1. 传统哈希取模算法的局限性

当我们对几个单词进行传统取模方法后记过如下:

![ch-three-nodes-hash.jpg](https://segmentfault.com/img/bVbA7aw)



## 1.1 节点减少

![ch-two-nodes-hash.jpg](https://segmentfault.com/img/bVbA7ay)



节点的减少会导致键与节点的映射关系发生变化，这个变化对于新的键来说并不会产生任何影响，但对于已有的键来说，将导致节点映射错误，以 “semlinker” 为例，变化前系统有 3 个节点，该键对应的节点编号为 1，当出现故障时，节点数减少为 2 个，此时该键对应的节点编号为 0。

## 1.2 节点增加

![ch-four-nodes-hash.jpg](https://segmentfault.com/img/bVbA7az)

节点的增加也会导致键与节点的映射关系发生变化，这个变化对于新的键来说并不会产生任何影响，但对于已有的键来说，将导致节点映射错误.



当集群中节点的数量发生变化时，之前的映射规则就可能发生变化。如果集群中每个机器提供的服务没有差别，这不会有什么影响。**但对于分布式缓存这种的系统而言，映射规则失效就意味着之前缓存的失效，若同一时刻出现大量的缓存失效，则可能会出现 “缓存雪崩”，这将会造成灾难性的后果。**

**要解决此问题，我们必须在其余节点上重新分配所有现有键，这可能是非常昂贵的操作，并且可能对正在运行的系统产生不利影响。当然除了重新分配所有现有键的方案之外，还有另一种更好的方案即使用一致性哈希算法**



## 2. 一致性哈希算法

### 2.1 原理

一致性哈希算法通过一个叫作一致性哈希环的数据结构实现。这个环的起点是 0，终点是 2^32 - 1，并且起点与终点连接，故这个环的整数分布范围是 [0, 2^32-1]，如下图所示

![hash-ring.jpg](https://segmentfault.com/img/bVbA7aA)

将数据放到环上,得到如下几种

![img](https://leehao.oss-cn-shenzhen.aliyuncs.com/2019-06-03-141932.jpg)

然后将机器按照hash函数放到一致性哈希环中

![img](https://leehao.oss-cn-shenzhen.aliyuncs.com/2019-06-03-142003.jpg)

都加入到一致性哈希环后需要未对象分配机器.在hash环上顺时针查找距离这个对象的hash值最近的机器，即是这个对象所属的机器.分配后的情况如下:

![img](https://leehao.oss-cn-shenzhen.aliyuncs.com/2019-06-03-142032.jpg)

当机器数量增减时,比如当在m4到m3中新增C4机器,那么m4就需要重新分配到新机器中

![img](https://leehao.oss-cn-shenzhen.aliyuncs.com/2019-06-03-142100.jpg)



使用一致性hash算法后这种情况则会得到大大的改善。前面提到3台机器变成4台机器后，缓存命中率只有25%（不命中率75%）.而使用一致性hash算法，理想情况下缓存命中率则有75%，而且，随着机器规模的增加，命中率会进一步提高，99台机器增加一台后，命中率达到99%，这大大减轻了增加缓存机器带来的数据库访问的压力。

例如，将机器c1下线（当然，也有可能是机器c1宕机），这时，只有原有被分配到机器c1对象需要被重新分配到新的机器

![img](https://leehao.oss-cn-shenzhen.aliyuncs.com/2019-06-03-142144.jpg)

### 2.2 虚拟节点

将每台物理机器虚拟为一组虚拟机器，将虚拟机器放置到hash环上，如果需要确定对象的机器，先确定对象的虚拟机器，再由虚拟机器确定物理机器。

假设每台机器都有3个虚拟节点.

![img](https://leehao.oss-cn-shenzhen.aliyuncs.com/2019-06-03-142204.jpg)



新加入节点时再加入虚拟节点

![img](https://leehao.oss-cn-shenzhen.aliyuncs.com/2019-06-03-142223.jpg)



这3个虚拟节点分别对应机器c3，c2，c1。即新加入的一台机器，同时影响到原有的3台机器。理想情况下，新加入的机器平等地分担了原有机器的负载，这正是虚拟节点带来的好处

### 2.3 优点

- 可扩展性。一致性哈希算法保证了增加或减少服务器时，数据存储的改变最少，相比传统哈希算法大大节省了数据移动的开销 。

- 更好地适应数据的快速增长。采用一致性哈希算法分布数据，当数据不断增长时，部分虚拟节点中可能包含很多数据、造成数据在虚拟节点上分布不均衡，此时可以将包含数据多的虚拟节点分裂，这种分裂仅仅是将原有的虚拟节点一分为二、不需要对全部的数据进行重新哈希和划分。

  虚拟节点分裂后，如果物理服务器的负载仍然不均衡，只需在服务器之间调整部分虚拟节点的存储分布。这样可以随数据的增长而动态的扩展物理服务器的数量，且代价远比传统哈希算法重新分布所有数据要小很多

### 2.4 与哈希算法的关系

一致性哈希算法是在哈希算法基础上提出的，在动态变化的分布式环境中，哈希算法应该满足的几个条件：平衡性、单调性和分散性。

- 平衡性：是指 hash 的结果应该平均分配到各个节点，这样从算法上解决了负载均衡问题。
- 单调性：是指在新增或者删减节点时，不影响系统正常运行。
- 分散性：是指数据应该分散地存放在分布式集群中的各个节点（节点自己可以有备份），不必每个节点都存储所有的数据







参考 [一致性哈希算法](https://segmentfault.com/a/1190000021199728)

[一致性Hash(Consistent Hashing)原理剖析](https://leehao.me/%E4%B8%80%E8%87%B4%E6%80%A7Hash-Consistent-Hashing-%E5%8E%9F%E7%90%86%E5%89%96%E6%9E%90/)