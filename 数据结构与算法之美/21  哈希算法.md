# 21 | 哈希算法

## 如何防止数据库中的用户信息被脱库？

### 什么是哈希算法？

将任意长度的二进制值串映射为固定长度的二进制值串，这个映射的规则就是**哈希算法**，而通过原始数据映射之后得到的二进制值串就是**哈希值**

对于哈希算法的要求:

- 不能从哈希值逆推得到原始数据
- 不同数据生成的哈希值尽量不同
- 散列冲突概率下
- 执行高效

哈希算法的常见应用别是安全加密、唯一标识、数据校验、散列函数、负载均衡、数据分片、分布式存储.

### 应用一：安全加密

常见的哈希算法如MD5（MD5 Message-Digest Algorithm，MD5 消息摘要算法）.生成的哈希值为128位二进制串,最多能表示 2^128 个数据.当加密的数据数量大于该值时会产生散列冲突.

### 应用二：唯一标识

在海量图库中搜索某个图片,可以给每个图片生成一个唯一标识,根据这个标识获取相同图片并判断图片是否存在.

我们可以从图片的二进制码串开头取 100 个字节，从中间取 100 个字节，从最后再取 100 个字节，然后将这 300 个字节放到一块，通过哈希算法（比如 MD5），得到一个哈希字符串，用它作为图片的唯一标识

### 应用三：数据校验

 BT 下载时校验每个文件块.当文件块下载完成之后，我们可以通过相同的哈希算法，对下载好的文件块逐一求哈希值，然后跟种子文件中保存的哈希值比对

### 应用四：散列函数

散列函数是设计一个散列表的关键。它直接决定了散列冲突的概率和散列表的性能。不过，相对哈希算法的其他应用，散列函数对于散列算法冲突的要求要低很多。更加关注散列后的值是否能平均分布.

### 如何防止数据库中的用户信息被脱库

针对字典攻击，我们可以引入一个盐（salt），跟用户的密码组合在一起，增加密码的复杂度。我们拿组合之后的字符串来做哈希算法加密，将它存储到数据库中，进一步增加破解的难度。



引申,散列函数在区块链中的应用:[一文读懂区块链中的哈希算法](https://zhuanlan.zhihu.com/p/73769746)

 [keystore密钥文件使用的算法-PBKDF2WithHmacSHA1 和Scrypt ](https://www.cnblogs.com/wanghui-garcia/p/10007768.html)

## 哈希算法在分布式系统中有哪些应用

### 应用五：负载均衡

实现一个会话粘滞（session sticky）的负载均衡算法.

**我们可以通过哈希算法，对客户端 IP 地址或者会话 ID 计算哈希值，将取得的哈希值与服务器列表的大小进行取模运算，最终得到的值就是应该被路由到的服务器编号。确保同一个IP路由到相同的服务端**

### 应用六：数据分片

#### 如何统计“搜索关键词”出现的次数

大数据量下统计信息:**我们可以先对数据进行分片，然后采用多台机器处理的方法，来提高处理速度**

为了提高处理的速度，我们用 n 台机器并行处理。我们从搜索记录的日志文件中，依次读出每个搜索关键词，并且通过哈希函数计算哈希值，然后再跟 n 取模，最终得到的值，就是应该被分配到的机器编号.

#### 2. 如何快速判断图片是否在图库中？

当我们要判断一个图片是否在图库中的时候，我们通过同样的哈希算法，计算这个图片的唯一标识，然后与机器个数 n 求余取模。假设得到的值是 k，那就去编号 k 的机器构建的散列表中查找。

### 应用七：分布式存储

利用一致性哈希算法,将缓存打散.

假设我们有 k 个机器，数据的哈希值的范围是 [0, MAX]。我们将整个范围划分成 m 个小区间（m 远大于 k），每个机器负责 m/k 个小区间。当有新机器加入的时候，我们就将某几个小区间的数据，从原来的机器中搬移到新的机器中。这样，既不用全部重新哈希、搬移数据，也保持了各个机器上数据数量的均衡。

引申:[Consistent hashing](https://en.wikipedia.org/wiki/Consistent_hashing)
[白话解析：一致性哈希算法 consistent hashing](https://www.zsythink.net/archives/1182)