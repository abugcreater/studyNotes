# B+树

#### 树的简介

树跟数组、链表、堆栈一样，是一种数据结构。它由有限个节点，组成具有层次关系的集合。因为它看起来像一棵树，所以得其名

一些有关于树的概念：

> - 结点的度：一个结点含有的子结点个数称为该结点的度；
> - 树的度：一棵树中，最大结点的度称为树的度；
> - 父结点：若一个结点含有子结点，则这个结点称为其子结点的父结点；
> - 深度：对于任意结点n,n的深度为从根到n的唯一路径长，根结点的深度为0；
> - 高度：对于任意结点n,n的高度为从n到一片树叶的最长路径长，所有树叶的高度为0；

#### 树的种类

![img](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/4a80dc466f0e42a19f59d8dd6a151657~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp)


> - 二叉查找树：首先它是一颗二叉树，若左子树不空，则左子树上所有结点的值均小于它的根结点的值；若右子树不空，则右子树上所有结点的值均大于它的根结点的值；左、右子树也分别为二叉排序树；
> - 霍夫曼树：带权路径最短的二叉树。
> - 红黑树：红黑树是一颗特殊的二叉查找树，每个节点都是黑色或者红色，根节点、叶子节点是黑色。如果一个节点是红色的，则它的子节点必须是黑色的。
> - 平衡二叉树（AVL）：一 棵空树或它的左右两个子树的高度差的绝对值不超过1，并且左右两个子树都是一棵平衡二叉树

### B-树、B+树简介

#### B-树 简介

B-树，也称为B树，是一种平衡的多叉树.概念:

> - 阶数：一个节点最多有多少个孩子节点。（一般用字母m表示）
> - 关键字：节点上的数值就是关键字
> - 度：一个节点拥有的子节点的数量。

一颗m阶的B-树，有以下特征：

> - 根结点至少有两个子女；
> - 每个非根节点所包含的关键字个数 j 满足：⌈m/2⌉ - 1 <= j <= m - 1.(⌈⌉表示向上取整)
> - 有k个关键字(关键字按递增次序排列)的非叶结点恰好有k+1个孩子。
> - 所有的叶子结点都位于同一层。

#### B+ 树简介

B+树是B-树的变体，也是一颗多路搜索树。主要有这些特点：

> - 每个结点至多有m个子女;
> - 非根节点关键值个数范围：m/2 <= k <= m-1
> - 相邻叶子节点是通过指针连起来的，并且是关键字大小排序的。

B+树和B-树的主要区别:

1. B+树只有叶子节点保存数据,非叶子节点只做索引;B树内部节点保存数据
2. B+树相邻叶子节点间通过链表指针连接
3. 查找过程中，B树在找到具体的数值以后就结束，而B+树则需要通过索引找到叶子结点中的数据才结束
4. B数关键词只能出现在一个节点中,而B+树能出现多次

## B+树的操作

### B+树的插入

B+树插入要记住这几个步骤：

- 1.B+树插入都是在叶子结点进行的，就是插入前，需要先找到要插入的叶子结点。
- 2.如果被插入关键字的叶子节点，当前含有的关键字数量是小于阶数m，则直接插入。
- 3.如果插入关键字后，叶子节点当前含有的关键字数目等于阶数m，则插，该节点开始**分裂**为两个新的节点，一个节点包含⌊m/2⌋ 个关键字，另外一个关键字包含⌈m/2⌉个关键值。（⌊m/2⌋表示向下取整，⌈m/2⌉表示向上取整，如⌈3/2⌉=2）。
- 4.分裂后，需要将第⌈m/2⌉的关键字上移到父结点。如果这时候父结点中包含的关键字个数小于m，则插入操作完成。
- 5.分裂后，需要将⌈m/2⌉的关键字上移到父结点。如果父结点中包含的关键字个数等于m，则继续分裂父结点。

### B+树的查找

因为B+树的数据都是在叶子节点上的，内部节点只是指针索引的作用，因此，查找过程需要搜索到叶子节点上.

### B+树的删除

B+树删除关键字，分这几种情况

- 找到包含关键值的结点，如果关键字个数大于m/2，直接删除即可；
- 找到包含关键值的结点,如果关键字个数大于m/2，并且关键值是当前节点的最大（小）值，并且该关键值存在父子节点中，那么删除该关键字，同时需要相应调整父节点的值。
- 找到包含关键值的结点，如果删除该关键字后，关键字个数小于⌈m/2⌉，并且其兄弟结点有多余的关键字，则从其兄弟结点借用关键字
- 找到包含关键值的结点，如果删除该关键字后，关键字个数小于⌈m/2⌉，并且其兄弟结点没有多余的关键字，则与兄弟结点合并。

#### InnoDB一棵B+树可以存放多少行数据？

这个问题的简单回答是：约2千万行。

- 在计算机中，磁盘存储数据最小单元是扇区，一个扇区的大小是512字节。
- 文件系统中，最小单位是块，一个块大小就是4k；
- InnoDB存储引擎最小储存单元是页，一页大小就是16k。

假设B+树的高度为2的话，即有一个根结点和若干个叶子结点。这棵B+树的存放总记录数为=根结点指针数*单个叶子节点记录行数。

- 如果一行记录的数据大小为1k，那么单个叶子节点可以存的记录数 =16k/1k =16.
- 非叶子节点内存放多少指针呢？我们假设主键ID为bigint类型，长度为8字节，而指针大小在InnoDB源码中设置为6字节，所以就是8+6=14字节，16k/14B =16*1024B/14B = 1170


因此，一棵高度为2的B+树，能存放1170 * 16=18720条这样的数据记录。同理一棵高度为3的B+树，能存放1170 *1170 *16 =21902400，也就是说，可以存放两千万左右的记录。B+树高度一般为1-3层，已经满足千万级别的数据存储。

#### 为什么索引结构默认使用B+树，而不是B-Tree，Hash哈希，二叉树，红黑树？

简单版回答如下：

- Hash哈希，只适合等值查询，不适合范围查询。
- 一般二叉树，可能会特殊化为一个链表，相当于全表扫描。
- 红黑树，是一种特化的平衡二叉树，MySQL 数据量很大的时候，索引的体积也会很大，内存放不下的而从磁盘读取，树的层次太高的话，读取磁盘的次数就多了。
- B-Tree，叶子节点和非叶子节点都保存数据，相同的数据量，B+树更爱矮壮，也是就说，相同的数据量，B+树数据结构，查询磁盘的次数会更少。

- 单一节点存储的元素更多，使得查询的IO次数更少，所以也就使得它更适合做为数据库MySQL的底层数据结构了。
- 所有的查询都要查找到叶子节点，查询性能是稳定的，而B树，每个节点都可以查找到数据，所以不稳定。
- 所有的叶子节点形成了一个有序链表，更加便于查找







参考:[B+树详解](https://juejin.cn/post/6929833495082565646)

[B树和B+树](https://juejin.cn/post/6844903944292925447#heading-8)