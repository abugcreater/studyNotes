# 21 | 流量回放：保障业务技术升级的神器

流量就是某个时间段内的所有请求，我们通过某种手段把发送到 A 应用的所有请求录制下来，然后把这些请求统一转发到 B 应用，让 B 应用接收到的请求参数跟 A 应用保持一致，从而实现 A 接收到的请求在 B 应用里面重新请求了一遍。整个过程我们称之为“流量回放”。

### 流量回放可以做什么？

为了保障应用升级后，我们的业务行为还能保持和升级前一样，我们在大多数情况下都是依靠已有的 TestCase 去验证，但这种方式在一定程度上并不是完全可靠的。最可靠的方式就是引入线上 Case 去验证改造后的应用，把线上的真实流量在改造后的应用里面进行回放，这样不仅节省整个上线时间，还能弥补手动维护 Case 存在的缺陷。

### RPC 怎么支持流量回放？

既然所有的请求都会经过 RPC，在 RPC 里面拿到每次请求的出入参数,把这些出入参数旁录下来，并把这些旁录结果用异步的方式发送到一个固定的地方保存起来，这样就完成了流量回放里面的录制功能。

有了真实的请求入参之后，剩下的就是怎么把这些请求参数转发到我们要回归测试的应用里面。在 RPC 中，我们把能够接收请求的应用叫做服务提供方，那就是说我们只需要模拟一个应用调用方，把刚才收到的请求参数重新发送一遍到要回归测试的应用里面，然后比对录制拿到的请求结果和新请求的结果，就可以完成请求回放的效果。

![image-20220116180034709](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220116180034709.png)

参考:

[Nginx流量复制](https://www.cnblogs.com/cjsblog/p/12163207.html)
[关于“流量回放”的一些调研](https://www.jianshu.com/p/355324e92a0c)

[流量回放神器-OTDD](https://zhuanlan.zhihu.com/p/115330798)