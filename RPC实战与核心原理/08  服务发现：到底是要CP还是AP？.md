# 08 | 服务发现：到底是要CP还是AP？

### 为什么需要服务发现？

为了高可用，在生产环境中服务提供方都是以集群的方式对外提供服务，集群里面的这些 IP 随时可能变化，所以需要服务发现.

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220110154120670.png" alt="image-20220110154120670" style="zoom:60%;" />

服务注册：在服务提供方启动的时候，将对外暴露的接口注册到注册中心之中，注册中心将这个服务节点的 IP 和接口保存下来。

服务订阅：在服务调用方启动的时候，去注册中心查找并订阅服务提供方的 IP，然后缓存到本地，并用于后续的远程调用。

### 为什么不使用 DNS？

DNS的查询流程

![image-20220110154229157](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220110154229157.png)

DNS 采取了多级缓存机制，一般配置的缓存时间较长，特别是 JVM 的默认缓存是永久有效的，所以说服务调用者不能及时感知到服务节点的变化(比如摘除或上线)。

负债均衡方案

![image-20220110154349169](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220110154349169.png)

VIP方案不满足的地方

搭建负载均衡设备或 TCP/IP 四层代理，需求额外成本；

请求流量都经过负载均衡设备，多经过一次网络传输，会额外浪费些性能；

负载均衡添加节点和摘除节点，一般都要手动添加，当大批量扩容和下线时，会有大量的人工操作和生效延迟；

我们在服务治理的时候，需要更灵活的负载均衡策略，目前的负载均衡设备的算法还满足不了灵活的需求。

### 基于 ZooKeeper 的服务发现

基于Zookeeper的服务发现架构

![image-20220110154534294](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220110154534294.png)

1.服务平台管理端先在 ZooKeeper 中创建一个服务根路径,下面再创建服务提供方/调用方目录,存储提供方/调用方的节点信息

2.提供方发起注册时,在对应目录下创建临时节点,存储注册信息

3.调用方发起订阅时,在对应目录下创建临时节点,存储调用方信息,watch提供方所有服务节点数据

4.提供方目录下有节点数据发生变更时，ZooKeeper 就会通知给发起订阅的服务调用方。

缺点:当连接到 ZooKeeper 的节点数量特别多，对 ZooKeeper 读写特别频繁，且 ZooKeeper 存储的目录达到一定数量的时候，ZooKeeper 将不再稳定，CPU 持续升高，最终宕机。

### 基于消息总线的最终一致性的注册中心

消息总线机制:注册数据可以全量缓存在每个注册中心内存中，通过消息总线来同步数据。当有一个注册中心节点接收到服务节点注册时，会产生一个消息推送给消息总线，再通过消息总线通知给其它注册中心节点更新数据并进行服务下发，从而达到注册中心间数据最终一致性

![image-20220110155411990](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220110155411990.png)

- 当有服务上线，注册中心节点收到注册请求，服务列表数据发生变化，会生成一个消息，推送给消息总线，每个消息都有整体递增的版本。

- 消息总线会主动推送消息到各个注册中心，同时注册中心也会定时拉取消息。对于获取到消息的在消息回放模块里面回放，只接受大于本地版本号的消息，小于本地版本号的消息直接丢弃，从而实现最终一致性。

- 消费者订阅可以从注册中心内存拿到指定接口的全部服务实例，并缓存到消费者的内存里面。

- 采用推拉模式，消费者可以及时地拿到服务实例增量变化情况，并和内存中的缓存数据进行合并。



在服务调用方发送请求到目标节点后，目标节点会进行合法性验证，如果指定接口服务不存在或正在下线，则会拒绝该请求。服务调用方收到拒绝异常后，会安全重试到其它节点。



参考:

[CAP定理](https://en.wikipedia.org/wiki/CAP_theorem)

[consul服务发现](https://www.consul.io/docs/discovery/services)

