# 02 | 协议：怎么设计可扩展且向后兼容的协议？

### 协议的作用

方便RPC请求数据在转化为二进制后,服务提供方可以识别.传输的消息中包含了边界,用于标识请求数据的结束位置.这个边界语义的表达,就是我们所说的协议

### 如何设计协议？

相对于 HTTP 的用处，RPC 更多的是负责应用间的通信，所以性能要求相对更高。

**那怎么设计一个私有 RPC 协议呢？** 

RPC消息中请求大小不固定,所以协议体可以设计,一个固定长度的用来保存请求数据大小,后面保存消息.

![image-20220106151110967](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220106151110967.png)

上述值包含了断句效果,但是还需要确定序列化方式,协议长度,消息ID等协议参数.此时就拆分成协议体和协议头.

![image-20220106171123491](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220106171123491.png)

### 可扩展的协议

上图表示的是定长协议头,当往协议头中加参数时会导致兼容问题.如果像协议体加协议头参数会导致需要序列化才能获取协议头信息,造成资源浪费.

可扩展的协议关键在于让协议头支持可扩展,扩展后协议头的长度不能定长.此时需要补充不定长部分存储可变部分,还要有个固定的地方读取长度.整体协议就变成了三部分内容：固定部分、协议头内容、协议体内容.

![image-20220106171656020](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220106171656020.png)



**设计一个简单的 RPC 协议并不难，难的就是怎么去设计一个可“升级”的协议。**不仅要让我们在扩展新特性的时候能做到向下兼容，而且要尽可能地减少资源损耗，所以我们协议的结构不仅要支持协议体的扩展，还要做到协议头也能扩展。









参考:[HTTP协议格式详解](https://www.jianshu.com/p/8fe93a14754c)

