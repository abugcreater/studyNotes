# 09 | 健康检测：这个节点都挂了，为啥还要疯狂发请求？

怎么保证选择出来的连接一定是可用的?

**终极的解决方案是让调用方实时感知到节点的状态变化**

心跳机制实现方式
1. 基于TCP自带的心跳包，TCP的SO_KEEPALIVE选项可以，系统默认的默认跳帧频率为2小时，超过2小时后，本地的TCP 实现会发送一个数据包给远程的 Socket. 如果远程Socket 没有发回响应, TCP实现就会持续尝试 11 分钟, 直到接收到响应为止。 否则就会自动断开Socket连接。但TCP自带的心跳包无法检测比较敏感地知道对方的状态，默认2小时的空闲时间，对于大多数的应用而言太长了。可以手工开启KeepAlive功能并设置合理的KeepAlive参数。
2. 在应用层自己进行实现

### 健康检测的逻辑

服务方的状态一般会有三种情况

1. 健康状态：建立连接成功，并且心跳探活也一直成功；
2. 亚健康状态：建立连接成功，但是心跳请求连续失败；
3. 死亡状态：建立连接失败。

![image-20220110162852530](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220110162852530.png)

初始化时只有死亡或者健康.

健康状态的节点连续出现几次不能响应心跳请求的情况，那就会被标记为亚健康状态

亚健康状态，如果连续几次都能正常响应心跳请求，那就可以转回健康状态,如果还是不能响应则变为死亡状态

如果某个时间点里，死亡的节点能够重连成功，那它就可以重新被标记为健康状态。

### 具体的解决方案

我们回到问题的本源，核心是服务节点网络有问题，心跳间歇性失败。判断节点只通过心跳判断.

使用**可用率**解决方案.可用率的计算方式是某一个时间窗口内接口调用成功次数的百分比（成功次数 / 总调用次数）。当可用率低于某个比例就认为这个节点存在问题，把它挪到亚健康列表，这样既考虑了高低频的调用接口，也兼顾了接口响应时间不同的问题。

部署多个检测程序在不同的地方,防止由于网络故障导致的误判.







参考:

[consul的监控检测策略](https://learn.hashicorp.com/tutorials/consul/service-registration-external-services?in=consul/developer-discovery)

gossip-based 节点采样,edge-triggered updates边缘触发更新