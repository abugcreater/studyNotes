# 24 | 如何在线上环境里兼容多种RPC协议？

### 为什么要支持多协议？

不同的 RPC 框架都是随着互联网技术的发展而慢慢涌现出来的，而这些 RPC 框架可能在不同时期会被我们引入到不同的项目中解决当时应用之间的通信问题，这样就导致我们线上的生成环境中存在各种各样的 RPC 框架。

**该如何同意使用一种RPC框架呢？**

通过这种自下而上的滚动升级方式，最终是可以让所有的应用都切换到统一的 RPC 框架上,这种升级需要应用分层明确,如果互相调用则很难实现.

把所有的应用都改造成新 RPC 的使用方式，然后同时上线,对小团队来说可行.

在保持原有 RPC 使用方式不变的情况下，同时引入新的 RPC 框架的思路，是可以让所有的应用最终都能升级到我们想要升级的 RPC 上.切换成本高,且需要多次上线.

关键就在于要让新的 RPC 能同时支持多种 RPC 调用，当一个调用方切换到新的 RPC 之后，调用方和服务提供方之间就可以用新的协议完成调用；当调用方还是用老的 RPC 进行调用的话，调用方和服务提供方之间就继续沿用老的协议完成调用。

![image-20220116221132859](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220116221132859.png)

### 怎么优雅处理多协议？

每种协议约定的数据包格式是不一样的，而且每种协议开头都有一个协议编码，我们一般叫做 magic number。收到数据包后获取magic number,找到对应协议的数据格式,然后再根据这个格式解析二进制数据.

在收发数据包的时候，我们通过两次转换实现 RPC 内部的处理逻辑跟协议无关，同时保证调用方收到的数据格式跟调用请求过来的数据格式是一样的。整个流程如下图所示

![image-20220116221325105](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220116221325105.png)