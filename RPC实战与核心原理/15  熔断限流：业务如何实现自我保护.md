# 15 | 熔断限流：业务如何实现自我保护?

### 为什么需要自我保护？

保证在高访问量、高并发的场景下，应用系统依然稳定，服务依然高可用。

**那么在使用 RPC 时，业务又如何实现自我保护呢？**

最常见的方式就是限流了.

### 服务端的自我保护

在 RPC 调用中服务端的自我保护策略就是限流,可以先配置限流阈值,在服务端添加限流逻辑,之前业务前先执行限流逻辑.

**那服务端的限流逻辑又该如何实现呢？**

常见的限流算法有很多,计数器,滑动窗口,漏斗算法以及令牌桶算法等.

限流维度：IP地址、URL、用户令牌、用户组、设备信息等。

限流粒度：集群粒度、服务粒度、接口粒度。

因素:[常见限流算法及场景](https://segmentfault.com/a/1190000023552181)

可以通过 RPC 治理的管理端进行配置，再通过注册中心或者配置中心将限流阈值的配置下发到服务提供方的每个节点上，实现动态配置。

单机限流不精确,每个节点只知道自己的阈值.除此之外可以提供一个专门的限流服务，让每个节点都依赖一个限流服务，当请求流量打过来时，服务节点触发限流逻辑，调用这个限流服务来判断是否到达了限流阈值。

甚至可以将限流逻辑放在调用端，调用端在发出请求时先触发限流逻辑，调用限流服务，如果请求量已经到达了限流阈值，请求都不需要发出去，直接返回给动态代理一个限流异常即可。

### 调用端的自我保护

调用链下游出问题时,如果调用端没有自我保护会导致,上有的所有服务都出问题.**而最有效的自我保护方式就是熔断。**

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220112162405055.png" alt="image-20220112162405055" style="zoom:50%;" />

熔断器工作机制:在关闭、打开和半打开这三个状态之间的切换。正常时为关闭状态,熔断器手机异常指标信息,出现异常时打开,此时调用会被拦截.打开一段时间后变成板打开,如果服务端能正常响应则关闭,否则变成打开.

**如何整理熔断器?**

![image-20220112162830094](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220112162830094.png)

动态代理，因为在 RPC 调用的流程中，动态代理是 RPC 调用的第一个关口。在发出请求时先经过熔断器，如果状态是闭合则正常发出请求，如果状态是打开则执行熔断器的失败策略。



**总结**

服务保护一般就是限流、熔断、降级。
限流的落地方式有：Guava RateLimiter、lua+Redis、Sentinel等；
熔断：Hystrix、Resilience4j；
降级：服务降级，就是对不怎么重要的服务进行低优先级的处理。说白了，就是尽可能的把系统资源让给优先级高的服务。资源有限，而请求是无限的。



参考:

[sentinel中文文档](https://github.com/alibaba/Sentinel/wiki/%E4%BB%8B%E7%BB%8D)

[Nginx限流](https://www.nginx.com/blog/rate-limiting-nginx))

[限流算法实践](https://www.infoq.cn/article/ipxnuqwu3lgwxc8j7tzw)

[Hystrix技术解析](https://www.jianshu.com/p/3e11ac385c73)

[Token bucket wiki](https://en.wikipedia.org/wiki/Token_bucket)

[Fault Tolerance in a High Volume, Distributed System](https://netflixtechblog.com/fault-tolerance-in-a-high-volume-distributed-system-91ab4faae74a)

[hystrix how it works](https://github.com/Netflix/Hystrix/wiki/How-it-Works)