# 14 | 优雅启动：如何避免流量打到没有启动完成的节点？

应用启动时,热点代码编译成的机器码和类都没有加载,导致处理调用时压力较大.

### 启动预热

让刚启动的服务提供方应用不承担全部的流量，而是让它被调用的次数随着时间的移动慢慢增加，最终让流量缓和地增加到跟已经运行一段时间后的水平一样。

**如何实现这个功能呢**

调整负载均衡算法,对于刚启动的应用，我们可以让它被选择到的概率特别低，但这个概率会随着时间的推移慢慢变大，从而实现一个动态增加流量的过程。

**具体实现**

注册中心记录服务提供方的启动时间,服务调用方可以获取ip列表及启动时间,基于时间动态调节权重,并根据该权重做负载均衡.

<img src="C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220112140132741.png" alt="image-20220112140132741" style="zoom:50%;" />

### 延迟暴露

启动时Spring 容器会顺序加载 Spring Bean，如果某个 Bean 是 RPC 服务的话，我们不光要把它注册到 Spring-BeanFactory 里面去，还要把这个 Bean 对应的接口注册到注册中心

此时调用方调用,服务提供方没有启动完成的话，就会导致调用失败，从而使业务受损。

**怎么避免**

具体的做法就是在应用启动加载、解析 Bean 的时候，如果遇到了 RPC 服务的 Bean，只先把这个 Bean 注册到 Spring-BeanFactory 里面去，而并不把这个 Bean 对应的接口注册到注册中心，只有等应用启动完成后，才把接口注册到注册中心用于服务发现，从而实现让服务调用方延迟获取到服务提供方地址。

为了预热代码,可以在注册到注册中心前加Hook,模拟代码调用,从而使JVM指令预热起来.

![image-20220112140716179](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220112140716179.png)

 ### 怎么处理大批量重启

1、分时分批启动，就和灰度发布一样；
2、在请求低峰把，在热点的应用肯定是有使用低峰的；
3、如果必须同时大批量重启，为了保证服务的可用性，可以在低峰时期，限流

