# 11 | 负载均衡：节点负载差距这么大，为什么收到的流量还一样？

负载均衡主要分为软负载和硬负载，软负载就是在一台或多台服务器上安装负载均衡的软件，如 LVS、Nginx 等，硬负载就是通过硬件设备来实现的负载均衡，如 F5 服务器等。负载均衡的算法主要有随机法、轮询法、最小连接法等。

负债均衡特性: 

- 高性能:按不同分配规则自动将流量进行分摊
- 可扩展性:方便增加集群中设备或链路数量
- 高可靠性:系统中某个设备或链路故障不会导致服务终端
- 易配置性:配置和维护方便
- 透明性:用户无感知也不关心

### RPC 框架中的负载均衡

RPC 的负载均衡完全由 RPC 框架自身实现,算法包括随机权重、Hash、轮询，RPC 的服务调用者会与“注册中心”下发的所有服务节点建立长连接，在每次发起 RPC 调用时，服务调用者都会通过配置的负载均衡插件，自主选择一个服务节点，发起 RPC 调用请求。

### 如何设计自适应的负载均衡？

在手机服务节点的性能指标(CPU,内存,耗时)及节点状态后对节点打分.打分需要对每个指标设计权重占比.通过随机权重的策略来选择服务节.

![image-20220110223159692](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220110223159692.png)

1. 添加服务指标收集器，并将其作为插件，默认有运行时状态指标收集器、请求耗时指标收集器。
2. 运行时状态指标收集器收集服务节点 CPU 核数、CPU 负载以及内存等指标，在服务调用者与服务提供者的心跳数据中获取。
3. 请求耗时指标收集器收集请求耗时数据，如平均耗时、TP99、TP999 等。
4. 可以配置开启哪些指标收集器，并设置这些参考指标的指标权重，再根据指标数据和指标权重来综合打分。
5. 通过服务节点的综合打分与节点的权重，最终计算出节点的最终权重，之后服务调用者会根据随机权重的策略，来选择服务节点。





扩展:

[基于Docker + Consul + Nginx + Consul-Template的服务负载均衡实现](https://www.jianshu.com/p/fa41434d444a)

实现原理:通过consul-Template获取注册节点数,动态修改Nginx配置,利用Nginx去负载均衡



[使用 Spring Cloud Gateway + Ribbon 负载均衡实战](https://blog.csdn.net/lovelichao12/article/details/107062967)

[深入理解 Ribbon 的架构原理](https://mp.weixin.qq.com/s/4-rh20rAlTwMmROWa-IHsw)

ribbon 客户端负载均衡器,读取服务信息列表,存储在ribbon中.