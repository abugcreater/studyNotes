# 13 | 优雅关闭：如何避免服务停机带来的业务损失？

### 关闭微服务为什么有问题？

对调用方来说，它也无法预测到服务提供方要对哪些机器重启上线，因此负载均衡就有可能把要正在重启的机器选出来，这样就会导致把请求发送到正在重启中的机器里面，从而导致调用方不能拿到正确的响应结果。

![image-20220112093906905](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220112093906905.png)

服务重启时可能存在的问题:

- 调用方发请求前，目标服务已经下线。对于调用方来说，跟目标节点的连接会断开，这时候调用方可以立马感知到，并且在其健康列表里面会把这个节点挪掉，自然也就不会被负载均衡选中。
- 调用方发请求的时候，目标服务正在关闭，但调用方并不知道它正在关闭，而且两者之间的连接也没断开，所以这个节点还会存在健康列表里面，因此该节点就有一定概率会被负载均衡选中。

### 关闭流程

最没有效率的办法就是人工通知调用方,手动摘除下线机器.

当服务提供方关闭前，先通知注册中心进行下线，然后通过注册中心告诉调用方进行节点摘除.该方法依赖两次RPC调用,服务发现保证最终一致性,不保证实时性,无法做到优雅停机.



流程图

![image-20220112095809763](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220112095809763.png)

提供方应用内存里面维护一份调用方连接集合,服务要关闭的时候，挨个去通知调用方去下线这台机器.但是该方法在服务提供方关闭的时候，并没有正确处理关闭后接收到的新请求

### 优雅关闭

在 RPC 启动的时候，我们提前注册关闭钩子需要加入超时机制，并在里面添加了两个处理程序，一个负责开启关闭标识，一个负责安全关闭服务对象，服务对象在关闭的时候会通知调用方下线节点。同时需要在我们调用链里面加上挡板处理器，当新的请求来的时候，会判断关闭标识，如果正在关闭，则抛出特定异常。

我们也可以利用这个原理在服务对象加上引用计数器，每开始处理请求之前加一，完成请求处理减一，通过该计数器我们就可以快速判断是否有正在处理的请求。

![image-20220112101946724](C:\Users\Administrator\AppData\Roaming\Typora\typora-user-images\image-20220112101946724.png)

参考:

[Spring微服务项目实现优雅停机（平滑退出）](https://juejin.cn/post/6938740916911865887#heading-12)

[@Endpoint 注解生效原理解析](https://blog.csdn.net/kangsa998/article/details/103166953/)

[Spring boot 2.3优雅下线，距离生产还有多远？](https://blog.csdn.net/weixin_43970890/article/details/109294934)