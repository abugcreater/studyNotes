# 负载均衡

## 简介

负载均衡器将传入的请求分发到应用服务器和数据库等计算资源。无论哪种情况，负载均衡器将从计算资源来的响应返回给恰当的客户端.

负责均衡的功能:

- 防止请求进入不好的服务器
- 防止资源过载
- 帮助消除单一的故障点

架构图如下:

![img](https://github.com/donnemartin/system-design-primer/raw/master/images/h81n9iK.png)

## 负载均衡算法

从负载均衡的算法来看，又分为 随机，轮询，哈希，最小压力，当然可能还会加上权重的概念

### 随机

随机:随机就是没有规律的，随便从负载中获得一台，又分为完全随机和加权随机

**完全随机**:实现简单,但是性能不行

**加权随机**:为每台服务器设置了权重，权重大的服务器获得的概率大一些，权重小的服务器获得的概率小一些

加权随机实现:例如有三台服务器A权重2,B权重7,C权重1,那么每个服务器处理范围就如下表所示

|  A   |  B   |  C   |
| :--: | :--: | :--: |
| 1~2  | 3~9  |  10  |

之后根据随机范围选择转发服务器.

### 轮询

轮询又分为三种，1.完全轮询 2.加权轮询 3.平滑加权轮询

**完全轮询**:也是比较简单的，但是问题和完全随机是一样的

**加权轮询**:实现方式与加权随机类似,不过将获取index从随机改为递增轮询.但是会出现其他服务器不能实时负载

**平滑加权轮询**:为每个服务器设定固定权重,除此之外还有个非固定权重,“非固定权重”每次都会根据一定的规则变动。

| 请求 | 获得服务器前的非固定权重 | 选中的服务器 | 获得服务器后的非固定权重 |
| ---- | ------------------------ | ------------ | ------------------------ |
| 1    | {5, 1, 1}                | A            | {-2, 1, 1} (5-7,1,1)     |
| 2    | {3, 2, 2}(-2+5,1+1,1+1)  | A            | {-4, 2, 2}(3-7,2,2)      |
| 3    | {1, 3, 3}(-4+1,2+1,2+1)  | B            | {1, -4, 3}(1,3-7,3)      |

### 哈希

负载均衡算法中的哈希算法，就是根据某个值生成一个哈希值，然后对应到某台服务器上去，当然可以根据用户，也可以根据请求参数，或者根据其他，想怎么来就怎么来。

利用hash环,获取服务器的hash值将hash环分割成不同的大小,将这些段分配给不同的服务器,为了防止分配不均,需要用虚拟节点占位.

### 最小压力

最小压力负载均衡算法就是 选择一台当前最“悠闲”的服务器.



## 分类

负债均衡分为硬件负载均衡和软件负载均衡.

**硬件负载均衡**:直接在服务器和外部网络间安装负载均衡硬件设备,由专门的设备完成，独立于操作系统，整体性能得到大量提高，加上更多的负载均衡策略，智能化的流量管理，可达到最佳的负载均衡需求.一般性能优于软件,但是成本更贵.代表的如F5负载均衡器.

**软件负载均衡**:在服务器的操作系统上，安装软件，来实现负载均衡.优点是基于特定环境、配置简单、使用灵活、成本低廉，可以满足大部分的负载均衡需求。代表如Nginx,LVS等

软件负债均衡又分为四层负载均衡器与七层负载均衡器.

### 四层负载均衡

四层负载均衡根据监看[传输层](https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#通讯)的信息来决定如何分发请求。通常，这会涉及来源，目标 IP 地址和请求头中的端口，但不包括数据包（报文）内容。四层负载均衡执行[网络地址转换（NAT）](https://www.nginx.com/resources/glossary/layer-4-load-balancing/)来向上游服务器转发网络数据包。

### 七层负载均衡器

七层负载均衡器根据监控[应用层](https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#通讯)来决定怎样分发请求。这会涉及请求头的内容，消息和 cookie。七层负载均衡器终结网络流量，读取消息，做出负载均衡判定，然后传送给特定服务器。比如，一个七层负载均衡器能直接将视频流量连接到托管视频的服务器，同时将更敏感的用户账单流量引导到安全性更强的服务器。

以损失灵活性为代价，四层负载均衡比七层负载均衡花费更少时间和计算资源，虽然这对现代商用硬件的性能影响甚微。

## 水平扩展

负载均衡器还能帮助水平扩展，提高性能和可用性。使用商业硬件的性价比更高，并且比在单台硬件上**垂直扩展**更贵的硬件具有更高的可用性。相比招聘特定企业系统人才，招聘商业硬件方面的人才更加容易。

### 缺陷：水平扩展

- 水平扩展引入了复杂度并涉及服务器复制
  - 服务器应该是无状态的:它们也不该包含像 session 或资料图片等与用户关联的数据。
  - session 可以集中存储在数据库或持久化[缓存](https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#缓存)（Redis、Memcached）的数据存储区中。
- 缓存和数据库等下游服务器需要随着上游服务器进行扩展，以处理更多的并发连







参考:[负载均衡器](https://github.com/donnemartin/system-design-primer/blob/master/README-zh-Hans.md#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8)

[硬件均衡负载与软件均衡负载](https://blog.csdn.net/ccb1991/article/details/104535793/)

[浅谈负载均衡算法与实现](https://juejin.cn/post/6844903793012768781)

[四层负载平衡](https://www.nginx.com/resources/glossary/layer-4-load-balancing/)

[七层负载平衡](https://www.nginx.com/resources/glossary/layer-7-load-balancing/)

[NGINX 架构](https://www.nginx.com/blog/inside-nginx-how-we-designed-for-performance-scale/)



