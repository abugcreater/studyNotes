# 26.  Kubernetes GPU管理与Device Plugin机制

**GPU 支持对于 Kubernetes 项目来说，其实也有着超过技术本身的考虑**。

以 NVIDIA 的 GPU 设备为例,当容器被创建时必须出现如下两部分设备和目录:

1. GPU 设备，比如 /dev/nvidia0；
2. GPU 驱动目录，比如 /usr/local/nvidia/*。

GPU设备路径和驱动目录设置在创建容器的CRI(Container Runtime Interface)参数里面.

Kubernetes 在 Pod 的 API 对象中,使用了Extended Resource（ER）字段来传递GPU信息.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: cuda-vector-add
spec:
  restartPolicy: OnFailure
  containers:
    - name: cuda-vector-add
      image: "k8s.gcr.io/cuda-vector-add:v0.1"
      resources:
        limits:
          nvidia.com/gpu: 1
```

调取器不在乎字段的具体含义,只会在调度时获取ER的具体数值.

为了让调度器知道自定义资源的可用量,宿主机必须向API server上报,就是 Node 对象 Status 字段的内容，比如下面这个例子：

```yaml
apiVersion: v1
kind: Node
metadata:
  name: node-1
...
Status:
  Capacity:
   cpu:  2
   memory:  2049008Ki
```

可以使用curl PATCH操作,对这个Node对象进行更新.

```sh
# 启动 Kubernetes 的客户端 proxy，这样你就可以直接使用 curl 来跟 Kubernetes  的 API Server 进行交互了
$ kubectl proxy
 
# 执行 PACTH 操作
$ curl --header "Content-Type: application/json-patch+json" \
--request PATCH \
--data '[{"op": "add", "path": "/status/capacity/nvidia.com/gpu", "value": "1"}]' \
http://localhost:8001/api/v1/nodes/<your-node-name>/status
```

执行上述操作后,可以看到Node的Satus变更为如下内容:

```yaml
apiVersion: v1
kind: Node
...
Status:
  Capacity:
   cpu:  2
   memory:  2049008Ki
   nvidia.com/gpu: 1
```

----

Kubernetes 对所有硬件加速设备管理都是由Device Plugin插件负责,该插件也包括了对硬件的 Extended Resource 进行汇报的逻辑.机制如下图:

![k8s-26-1](..\..\img\k8s-26-1.png)

从左图可以看到,每种硬件设备都有对应的Device Plugin管理,通过grpc与kubelet链接.Device Plugin通过ListAndWatch定期向kubelet汇报设备列表.kubelet拿到了表后向APIServer发送心跳,内容包括Extended Resource及设备数量.

此外ListAndWatch汇报时,kubelet还会将信息保存到内存中,通过ListAndWatch定时更新.

当有Pod需要相关资源师,调度器会寻找满足条件的Node,并扣除请求的数量.调度成功后kubelet 会分配对应的设备给Pod.这步操作通过kubelet 就会向本机的 Device Plugin 发起一个 Allocate() 请求完成.

当 Device Plugin 收到 Allocate 请求之后，它就会根据 kubelet 传递过来的设备 ID，从 Device Plugin 里找到这些设备对应的设备路径和驱动目录。

当这些路径返回给kubelet 后,kubelet 会将这些信息追加到CRI请求中,那么容器就会把设备需要的目录挂载进去.

---

对于其他类型硬件来说，要想在 Kubernetes 所管理的容器里使用这些硬件的话，也需要遵循上述 Device Plugin 的流程来实现如下所示的 Allocate 和 ListAndWatch API：

```go
  service DevicePlugin {
        // ListAndWatch returns a stream of List of Devices
        // Whenever a Device state change or a Device disappears, ListAndWatch
        // returns the new list
        rpc ListAndWatch(Empty) returns (stream ListAndWatchResponse) {}
        // Allocate is called during container creation so that the Device
        // Plugin can run device specific operations and instruct Kubelet
        // of the steps to make the Device available in the container
        rpc Allocate(AllocateRequest) returns (AllocateResponse) {}
          }
```





























































































