# 2. 容器部署

Kubernetes 希望你用 YAML 文件的方式，即：把容器的定义、参数、配置，统统记录在一个 YAML 文件中，然后用这样一句指令把它运行起来：

```sh
$ kubectl create -f 我的配置文件
```

### 配置文件解析

```yaml
apiVersion: apps/v1
kind: Deployment    #对象类型为Deployment
metadata:  #API对象标识(元数据)
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx  #label selector 标签类型是nginx
  replicas: 2  #副本数量为2
  template: #spec.template(pod模版):描述创建pod的细节
    metadata: #存放对象元数据
      labels:
        app: nginx
    spec:  #存放对象独有定义
      containers:
      - name: nginx
        image: nginx:1.7.9
        ports:
        - containerPort: 80
```

一个YAML文件在K8S中对应了一个API 对象.

在 Metadata 中，还有一个与 Labels 格式、层级完全相同的字段叫 **Annotations**，它专门用来携带 **key-value 格式的内部信息**。所谓内部信息，指的是对这些信息感兴趣的，是 Kubernetes 组件本身，而不是用户。所以大多数 Annotations，都是**在 Kubernetes 运行过程中，被自动加在这个 API 对象上**。

```
$ kubectl get pods -l app=nginx
NAME                                READY     STATUS    RESTARTS   AGE
nginx-deployment-67594d6bf6-9gdvr   1/1       Running   0          10m
nginx-deployment-67594d6bf6-v6j7w   1/1       Running   0          10m
```

 -l 参数，即获取所有匹配 app: nginx 标签的 Pod,**key-value参数在命令行中使用"="标识**



### 查看

kubectl describe 命令，查看一个 API 对象的细节

```powershell
$ kubectl describe pod nginx-deployment-67594d6bf6-9gdvr
Name:               nginx-deployment-67594d6bf6-9gdvr
Namespace:          default
Priority:           0
PriorityClassName:  <none>
Node:               node-1/10.168.0.3
Start Time:         Thu, 16 Aug 2018 08:48:42 +0000
Labels:             app=nginx
                    pod-template-hash=2315082692
Annotations:        <none>
Status:             Running
IP:                 10.32.0.23
Controlled By:      ReplicaSet/nginx-deployment-67594d6bf6
...
Events:
 
  Type     Reason                  Age                From               Message
 
  ----     ------                  ----               ----               -------
  
  Normal   Scheduled               1m                 default-scheduler  Successfully assigned default/nginx-deployment-67594d6bf6-9gdvr to node-1
  Normal   Pulling                 25s                kubelet, node-1    pulling image "nginx:1.7.9"
  Normal   Pulled                  17s                kubelet, node-1    Successfully pulled image "nginx:1.7.9"
  Normal   Created                 17s                kubelet, node-1    Created container
  Normal   Started                 17s                kubelet, node-1    Started container
```

在 Kubernetes 执行的过程中，对 API 对象的所有重要操作，都会被记录在这个对象的 **Events（事件）**里，并且显示在 kubectl describe 指令返回的结果中。

**如果有异常发生，你一定要第一时间查看这些 Events**，往往可以看到非常详细的错误信息。

### 更新

如果需要更新这个pod,那么需要修改yaml配置文件,并令其生效即可.

```sh
$ kubectl apply -f nginx-deployment.yaml
 
# 修改 nginx-deployment.yaml 的内容
 
$ kubectl apply -f nginx-deployment.yaml /  $ kubectl replace -f nginx-deployment.yaml
```

所以说，如果通过容器镜像，我们能够保证应用本身在开发与部署环境里的一致性的话，那么现在，Kubernetes 项目通过这些 YAML 文件，就保证了应用的“部署参数”在开发与部署环境中的一致性。

**而当应用本身发生变化时，开发人员和运维人员可以依靠容器镜像来进行同步；当应用部署参数发生变化时，这些 YAML 文件就是他们相互沟通和信任的媒介。**

### Volume

在 Kubernetes 中，Volume 是属于 Pod 对象的一部分。所以，我们就需要修改这个 YAML 文件里的 template.spec 字段，如下所示：

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  selector:
    matchLabels:
      app: nginx
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:1.8
        ports:
        - containerPort: 80
        volumeMounts: #声明要挂载的Volume 
        - mountPath: "/usr/share/nginx/html"
          name: nginx-vol
      volumes:   # 定义了这个Pod声明的所有volume
      - name: nginx-vol
        emptyDir: {}
```

类型为emptyDir 的Volume (存储卷):不显示声明宿主机目录的Volume .所以，Kubernetes 也会在宿主机上创建一个临时目录，这个目录将来就会被绑定挂载到容器所声明的 Volume 目录上。

而 Pod 中的容器，使用的是 volumeMounts 字段来声明自己要挂载哪个 Volume，并通过 **mountPath 字段来定义容器内的 Volume 目录**，比如：/usr/share/nginx/html。也可以通过hostPath显示定义.

```yaml
 ...   
    volumes:
      - name: nginx-vol
        hostPath: 
          path: /var/data
```

使用 kubectl describe 查看一下最新的 Pod，就会发现 Volume 的信息已经出现在了 Container 描述部分：

```yaml
...
Containers:
  nginx:
    Container ID:   docker://07b4f89248791c2aa47787e3da3cc94b48576cd173018356a6ec8db2b6041343
    Image:          nginx:1.8
    ...
    Environment:    <none>
    Mounts:
      /usr/share/nginx/html from nginx-vol (rw)
...
Volumes:
  nginx-vol:
    Type:    EmptyDir (a temporary directory that shares a pod's lifetime)
```

最后，你还可以使用 kubectl exec 指令，进入到这个 Pod 当中（即容器的 Namespace 中）查看这个 Volume 目录：

```sh
$ kubectl exec -it nginx-deployment-5c678cfb6d-lg9lw -- /bin/bash
# ls /usr/share/nginx/html
```







