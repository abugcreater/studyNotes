# 12. 聪明的微创新：Operator工作原理解读

Operator是Kubernetes 生态中相对更加灵活和编程友好的管理“有状态应用”的解决方案.已 Etcd Operator说明他的使用方式.

**第一步，将这个 Operator 的代码 Clone 到本地：**

```sh
$ git clone https://github.com/coreos/etcd-operator
```

**第二步，将这个 Etcd Operator 部署在 Kubernetes 集群里。**

```sh
$ example/rbac/create_role.sh
```

个脚本的作用，就是为 Etcd Operator 创建 RBAC 规则,描述对CRD 对象,API 对象和 `etcd.database.coreos.com` 这个 API Group 的 CR（Custom Resource）对象，有所有权限

> **定制资源（Custom Resource）** 是对 Kubernetes API 的扩展。 

而 Etcd Operator 本身，其实就是一个 Deployment，它的 YAML 文件如下所示：

```yaml
apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: etcd-operator
spec:
  replicas: 1
  template:
    metadata:
      labels:
        name: etcd-operator
    spec:
      containers:
      - name: etcd-operator
        image: quay.io/coreos/etcd-operator:v0.9.2
        command:
        - etcd-operator
        env:
        - name: MY_POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: MY_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
```

当创建这个operator后会自动生成CRD,查看这个CRD对象.

```sh
$ kubectl describe crd  etcdclusters.etcd.database.coreos.com
...
Group:   etcd.database.coreos.com
  Names:
    Kind:       EtcdCluster
    List Kind:  EtcdClusterList
    Plural:     etcdclusters
    Short Names:
      etcd
    Singular:  etcdcluster
  Scope:       Namespaced
  Version:     v1beta2
  
```

这个 CRD 相当于告诉了 Kubernetes：接下来，如果有 API 组（Group）是`etcd.database.coreos.com`、API 资源类型（Kind）是“EtcdCluster”的 YAML 文件被提交上来，你可一定要认识啊.

 Etcd Operator 部署好之后,只需要编写一个 EtcdCluster 的 YAML 文件就能部署一个Etcd集群了.这个YAML详情如下:

```yaml
apiVersion: "etcd.database.coreos.com/v1beta2"
kind: "EtcdCluster"
metadata:
  name: "example-etcd-cluster"
spec:
  size: 3
  version: "3.2.13"
```

**Operator 的工作原理，实际上是利用了 Kubernetes 的自定义 API 资源（CRD），来描述我们想要部署的“有状态应用”；然后在自定义控制器里，根据自定义 API 对象的变化，来完成具体的部署和运维工作。**

----

**集群的创建**

一般etcd集群的创建步骤是在启动时加入–initial-cluster 参数.让这些节点知道需要和哪些节点通信.

```sh
$ etcd --name infra0 --initial-advertise-peer-urls http://10.0.1.10:2380 \
  --listen-peer-urls http://10.0.1.10:2380 \
...
  --initial-cluster-token etcd-cluster-1 \
  --initial-cluster infra0=http://10.0.1.10:2380,infra1=http://10.0.1.11:2380,infra2=http://10.0.1.12:2380 \
  --initial-cluster-state new
  
```

Etcd Operator 的实现，虽然选择的也是静态集群，但这个集群具体的组建过程，是逐个节点动态添加的方式，即：

**首先，Etcd Operator 会创建一个“种子节点”；**
**然后，Etcd Operator 会不断创建新的 Etcd 节点，然后将它们逐一加入到这个集群当中，直到集群的节点数等于 size。**



我们可以把这个创建种子节点（集群）的阶段称为：**Bootstrap**。

接下来，**对于其他每一个节点，Operator 只需要执行如下两个操作即可**，以 infra1 为例。

第一步：通过 Etcd 命令行添加一个新成员：

```sh
$ etcdctl member add infra1 http://10.0.1.11:2380
```

第二步：为这个成员节点生成对应的启动参数，并启动它：

```sh
$ etcd
    --data-dir=/var/etcd/data
    --name=infra1
    --initial-advertise-peer-urls=http://10.0.1.11:2380
    --listen-peer-urls=http://0.0.0.0:2380
    --listen-client-urls=http://0.0.0.0:2379
    --advertise-client-urls=http://10.0.1.11:2379
    --initial-cluster=infra0=http://10.0.1.10:2380,infra1=http://10.0.1.11:2380
    --initial-cluster-state=existing
```



**Cluster 对象的第二个工作，则是启动该集群所对应的控制循环。**

获取Pod数量,控制到size值.























引用:

[定制资源](https://kubernetes.io/zh-cn/docs/concepts/extend-kubernetes/api-extension/custom-resources/)















































