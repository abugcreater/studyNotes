# 动态扩缩你的应用

### 扩缩应用程序

在之前的模块中，我们创建了一个 [Deployment](https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/)，然后通过 [Service](https://kubernetes.io/zh-cn/docs/concepts/services-networking/service/)让其可以开放访问。Deployment 仅为跑这个应用程序创建了一个 Pod。 当流量增加时，我们需要扩容应用程序满足用户需求。

**扩缩** 是通过改变 Deployment 中的副本数量来实现的。

## 扩缩概述

![img](https://d33wubrfki0l68.cloudfront.net/043eb67914e9474e30a303553d5a4c6c7301f378/0d8f6/docs/tutorials/kubernetes-basics/public/images/module_05_scaling1.svg)

扩展 Deployment 将创建新的 Pods，并将资源调度请求分配到有可用资源的节点上，收缩 会将 Pods 数量减少至所需的状态。Kubernetes 还支持 Pods 的[自动缩放](https://kubernetes.io/zh-cn/docs/tasks/run-application/horizontal-pod-autoscale/)。将 Pods 数量收缩到0也是可以的，但这会终止 Deployment 上所有已经部署的 Pods。

运行应用程序的多个实例需要在它们之间分配流量。服务 (Service)有一种负载均衡器类型，可以将网络流量均衡分配到外部可访问的 Pods 上。服务将会一直通过端点来监视 Pods 的运行，保证流量只分配到可用的 Pods 上。

## 实际操作

### 1. 扩展deployment

首先使用`kubectl get deployments`命令获取当前deployment.

返回信息包括:Name集群名称;READY展示当前和期望间比例;UP-TO-DATE显示已更新以达到所需状态的副本数;*AVAILABLE* 展示当前活跃的副本数量;*AGE* 展示运行时间.

通过`kubectl get rs`获取ReplicaSet 信息,发现ReplicaSet 的名称由`[DEPLOYMENT-NAME]-[RANDOM-STRING]`组成.

接下来我们想要将deployment中的副本扩展到4个时,我们需要使用`kubectl scale`命令.后面跟deployment 类型,名称和期望数量,完整命令如下:

````
kubectl scale deployments/kubernetes-bootcamp --replicas=4
````

再获取deployments信息发现数量已经更新.接下来让我们检查pods的数量是否已经改变:

```
kubectl get pods -o wide
```

当前pods数量已经变更为4个了.

### 2. 负载均衡

让我们检查一下 Service 是否正在对流量进行负载平衡。

首先创建NODE_PORT 环境变量来保存相关的端口号:

```
export NODE_PORT=$(kubectl get services/kubernetes-bootcamp -o go-template='{{(index .spec.ports 0).nodePort}}')
echo NODE_PORT=$NODE_PORT
```

让我们通过`curl`指令去检测暴露的IP和端口号,多次执行:

```sh
$ curl localhost:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-fb5c67579-xpfz6 | v=1
$ curl localhost:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-fb5c67579-hmdc8 | v=1
$ curl localhost:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-fb5c67579-qpdm4 | v=1
$ curl localhost:$NODE_PORT
Hello Kubernetes bootcamp! | Running on: kubernetes-bootcamp-fb5c67579-vbnqg | v=1
```

发现service负载均衡应用了.

### 3. 缩容

如果我们需要缩容只需要再次执行`scale`命令即可:

```
kubectl scale deployments/kubernetes-bootcamp --replicas=2
```

当我们查看Pods信息时:

```
$ kubectl get pods -o wide
NAME                                  READY   STATUS        RESTARTS   AGE   IP           NODE       NOMINATED NODE   READINESS GATES
kubernetes-bootcamp-fb5c67579-hmdc8   1/1     Terminating   0          10m   172.18.0.7   minikube   <none>           <none>
kubernetes-bootcamp-fb5c67579-qpdm4   1/1     Running       0          19m   172.18.0.6   minikube   <none>           <none>
kubernetes-bootcamp-fb5c67579-vbnqg   1/1     Terminating   0          10m   172.18.0.8   minikube   <none>           <none>
kubernetes-bootcamp-fb5c67579-xpfz6   1/1     Running       0          10m   172.18.0.9   minikube   <none>           <none>
```

发现只剩两个Pod存活.









参考:[运行应用程序的多个实例](https://kubernetes.io/zh-cn/docs/tutorials/kubernetes-basics/scale/scale-intro/)