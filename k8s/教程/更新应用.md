# 更新应用

### 更新应用程序

用户希望应用程序始终可用，而开发人员则需要每天多次部署它们的新版本。在 Kubernetes 中，这些是通过滚动更新（Rolling Updates）完成的。 **滚动更新** 允许通过使用新的实例逐步更新 Pod 实例，零停机进行 Deployment 更新。新的 Pod 将在具有可用资源的节点上进行调度。

 在 Kubernetes 中，更新是经过版本控制的，任何 Deployment 更新都可以恢复到以前的（稳定）版本。

## 滚动更新概述

![img](https://d33wubrfki0l68.cloudfront.net/9b57c000ea41aca21842da9e1d596cf22f1b9561/91786/docs/tutorials/kubernetes-basics/public/images/module_06_rollingupdates3.svg)

与应用程序扩展类似，如果 Deployment 是公开的，服务将在更新期间仅对可用的 pod 进行负载均衡。可用 Pod 是应用程序用户可用的实例。

滚动更新允许以下操作：

- 将应用程序从一个环境提升到另一个环境（通过容器镜像更新）
- 回滚到以前的版本
- 持续集成和持续交付应用程序，无需停机

## 实际操作

### 1. 更新应用版本

要查看应用程序的当前映像版本，请运行 describe pods 命令并查找 Image 字段：`kubectl describe pods`

如果想要将应用升级到版本2,那么我们需要使用`set image`命令,后面跟着deployment 和新的镜像版本:

```
kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=jocatalin/kubernetes-bootcamp:v2
```

该命令通知部署为您的应用程序使用不同的映像并启动滚动更新。检查新 Pod 的状态，并使用 get pods 命令查看旧 Pod 终止

### 2. 验证更新

我们需要验证更新必须通过暴露服务然后使用service去做负载均衡.过程与之前教程一致,故省略.

我们也可以通过`rollout status`命令确定更新.` kubectl rollout status deployments/kubernetes-bootcamp`

然后使用`kubectl describe pods`命令查看输出的`Image`字段查看版本号.

### 3.回滚

我们先将镜像改成v10

```
kubectl set image deployments/kubernetes-bootcamp kubernetes-bootcamp=gcr.io/google-samples/kubernetes-bootcamp:v10
```

然后查看deployments的状态.查看所有存活的Pods信息.

```
$ kubectl get pods
NAME                                   READY   STATUS             RESTARTS   AGE
kubernetes-bootcamp-59b7598c77-njw7c   0/1     ImagePullBackOff   0          70s
kubernetes-bootcamp-59b7598c77-php46   0/1     ErrImagePull       0          70s
kubernetes-bootcamp-7d44784b7c-qgcvk   1/1     Running            0          8m21s
kubernetes-bootcamp-7d44784b7c-qrdqr   1/1     Running            0          8m18s
kubernetes-bootcamp-7d44784b7c-vfxgf   1/1     Running            0          8m21s
```

发现有些节点的状态是`ImagePullBackOff`,想要更深程度的探索问题需要`describe pods`命令.

```
Events:
  Type     Reason     Age                 From               Message
  ----     ------     ----                ----               -------
  Normal   Scheduled  3m5s                default-scheduler  Successfully assigned default/kubernetes-bootcamp-59b7598c77-njw7c to minikube
  Normal   Pulling    91s (x4 over 3m4s)  kubelet            Pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed     90s (x4 over 3m3s)  kubelet            Failed to pull image "gcr.io/google-samples/kubernetes-bootcamp:v10": rpc error: code = Unknown desc = Error response from daemon: manifest for gcr.io/google-samples/kubernetes-bootcamp:v10 not found: manifest unknown: Failed to fetch "v10" from request "/v2/google-samples/kubernetes-bootcamp/manifests/v10".
  Warning  Failed     90s (x4 over 3m3s)  kubelet            Error: ErrImagePull
  Normal   BackOff    80s (x6 over 3m2s)  kubelet            Back-off pulling image "gcr.io/google-samples/kubernetes-bootcamp:v10"
  Warning  Failed     65s (x7 over 3m2s)  kubelet            Error: ImagePullBackOff

```

发现问题是拉取镜像的时候出错,仓库中没有V10版本的镜像.

要将部署回滚到上一个工作版本，请使用 rollout undo 命令：

```
kubectl rollout undo deployments/kubernetes-bootcamp
```

rollout undo 命令将部署恢复到以前的已知状态（映像的 v2）。更新是版本化的，您可以恢复到任何以前已知的部署状态。







参考:[执行滚动更新](https://kubernetes.io/zh-cn/docs/tutorials/kubernetes-basics/update/update-intro/)