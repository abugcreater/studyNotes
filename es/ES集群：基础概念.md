# ES集群：基础概念

## ES单机中相关概念

- **Index：**索引，由一个和多个分片组成，通过索引的名字在集群内进行唯一标识。

- **Type：**类别，指索引内部的逻辑分区，通过 Type 的名字在索引内进行唯一标识。在查询时如果没有该值，则表示在整个索引中查询。

- **Document：**文档，索引中的每一条数据叫作一个文档，类似于关系型数据库中的一条数据通过 _id 在 Type 内进行唯一标识。

- **Settings：**对集群中索引的定义，比如一个索引默认的分片数、副本数等信息。

- **Mapping：**类似于关系型数据库中的**表结构信息**，用于定义索引中字段（Field）的存储类型、分词方式、是否存储等信息。Elasticsearch 中的 Mapping 是可以动态识别的。
  - 如果没有特殊需求，则不需要手动创建 Mapping，因为 Elasticsearch 会自动根据数据格式识别它的类型，但是当需要对某些字段添加特殊属性（比如：定义使用其他分词器、是否分词、是否存储等）时，就需要手动设置 Mapping 了。一个索引的 Mapping 一旦创建，若已经存储了数据，就不可修改了。

- **Analyzer：**字段的分词方式的定义。一个 Analyzer 通常由一个 Tokenizer、零到多个 Filter 组成。
  - 比如默认的标准 Analyzer 包含一个标准的 Tokenizer 和三个 Filter：Standard Token Filter、Lower Case Token Filter、Stop Token Filter。

## ES集群中相关概念

- **Cluster：**集群，由一个或多个 Elasticsearch 节点组成。

- **Node：**节点，组成 Elasticsearch 集群的服务单元，同一个集群内节点的名字不能重复。通常在一个节点上分配一个或者多个分片。

- **Shards：**分片，当索引上的数据量太大的时候，我们通常会将一个索引上的数据进行水平拆分，拆分出来的每个数据库叫作一个分片。
  - 在一个多分片的索引中写入数据时，通过路由来确定具体写入那一个分片中，所以在创建索引时需要指定分片的数量，并且分片的数量一旦确定就不能更改。
  - 分片后的索引带来了规模上（数据水平切分）和性能上（并行执行）的提升。每个分片都是 Luence 中的一个索引文件，每个分片必须有一个主分片和零到多个副本分片。

- **Replicas：**备份也叫作副本，是指对主分片的备份。主分片和备份分片都可以对外提供查询服务，写操作时先在主分片上完成，然后分发到备份上。
  - 当主分片不可用时，会在备份的分片中选举出一个作为主分片，所以备份不仅可以提升系统的高可用性能，还可以提升搜索时的并发性能。但是若副本太多的话，在写操作时会增加数据同步的负担。





## ES集群各节点类型

- **①主节点（Master Node）：**也叫作主节点，主节点负责创建索引、删除索引、分配分片、追踪集群中的节点状态等工作。Elasticsearch 中的主节点的工作量相对较轻。
  - 用户的请求可以发往任何一个节点，并由该节点负责分发请求、收集结果等操作，而并不需要经过主节点转发。
  - 通过在配置文件中设置 node.master=true 来设置该节点成为候选主节点（但该节点不一定是主节点，主节点是集群在候选节点中选举出来的），在 Elasticsearch 集群中只有候选节点才有选举权和被选举权。其他节点是不参与选举工作的。

- **②数据节点（Data Node）：**数据节点，负责数据的存储和相关具体操作，比如索引数据的创建、修改、删除、搜索、聚合。
  - 所以，数据节点对机器配置要求比较高，首先需要有足够的磁盘空间来存储数据，其次数据操作对系统 CPU、Memory 和 I/O 的性能消耗都很大。
  - 通常随着集群的扩大，需要增加更多的数据节点来提高可用性。通过在配置文件中设置 node.data=true 来设置该节点成为数据节点。

- **③客户端节点（Client Node）：**就是既不做候选主节点也不做数据节点的节点，只负责请求的分发、汇总等，也就是下面要说到的协调节点的角色。

  - 其实任何一个节点都可以完成这样的工作，单独增加这样的节点更多地是为了提高并发性。

  - 可在配置文件中设置该节点成为数据节点：`node.master=falsenode.data=false`

- **④部落节点（Tribe Node）：**部落节点可以跨越多个集群，它可以接收每个集群的状态，然后合并成一个全局集群的状态。

  - 它可以读写所有集群节点上的数据，在配置文件中通过如下设置使节点成为部落节点：

  `tribe:  one:    cluster.name: cluster_one  two:    cluster.name: cluster_two`
  **因为 Tribe Node 要在 Elasticsearch 7.0 以后移除，所以不建议使用**

- **⑤协调节点（Coordinating Node）：**协调节点，是一种角色，而不是真实的 Elasticsearch 的节点，我们没有办法通过配置项来配置哪个节点为协调节点。集群中的**任何节点都可以充当**协调节点的角色。

  - 当一个节点 A 收到用户的查询请求后，会把查询语句分发到其他的节点，然后合并各个节点返回的查询结果，最好返回一个完整的数据集给用户。
  - 在这个过程中，节点 A 扮演的就是协调节点的角色。由此可见，协调节点会对 CPU、Memory 和 I/O 要求比较高。

  

**集群的状态有 Green、Yellow 和 Red 三种**，如下所述：

- **Green：绿色，健康**。所有的主分片和副本分片都可正常工作，集群 100% 健康。

- **Yellow：黄色，预警**。所有的主分片都可以正常工作，但至少有一个副本分片是不能正常工作的。此时集群可以正常工作，但是集群的高可用性在某种程度上被弱化。

- **Red：红色，集群不可正常使用**。集群中至少有一个分片的主分片及它的全部副本分片都不可正常工作。这时虽然集群的查询操作还可以进行，但是也只能返回部分数据（其他正常分片的数据可以返回），而分配到这个分片上的写入请求将会报错，最终会导致数据的丢失。

## 3C 和脑裂

**共识性（Consensus）**
共识性是分布式系统中最基础也最主要的一个组件，在分布式系统中的所有节点必须对给定的数据或者节点的状态达成共识。

虽然现在有很成熟的共识算法如 Raft、Paxos 等，也有比较成熟的开源软件如 Zookeeper。

但是 Elasticsearch 并没有使用它们，而是自己实现共识系统 zen discovery。

> *Elasticsearch 之父 Shay Banon 解释了其中主要的原因：“zen discovery 是 Elasticsearch 的一个核心的基础组件，zen discovery 不仅能够实现共识系统的选择工作，还能够很方便地监控集群的读写状态是否健康。当然，我们也不保证其后期会使用 Zookeeper 代替现在的 zen discovery”。*

zen discovery 模块以 “八卦传播”（Gossip）的形式实现了单播（Unicat）：单播不同于多播（Multicast）和广播（Broadcast）。节点间的通信方式是一对一的。





**②并发（Concurrency）**
Elasticsearch 是一个分布式系统。写请求在发送到主分片时，同时会以并行的形式发送到备份分片，但是这些请求的送达时间可能是无序的。

在这种情况下，Elasticsearch 用**乐观并发控制**（Optimistic Concurrency Control）来保证新版本的数据不会被旧版本的数据覆盖。

乐观并发控制是一种乐观锁，另一种常用的乐观锁即多版本并发控制（Multi-Version Concurrency Control）。

它们的主要区别如下：

乐观并发控制（OCC）：是一种用来解决**写 - 写冲突**的无锁并发控制，认为事务间的竞争不激烈时，就先进行修改，在提交事务前检查数据有没有变化，如果没有就提交，如果有就放弃并重试。乐观并发控制类似于自选锁，适用于低数据竞争且写冲突比较少的环境。

多版本并发控制（MVCC）：是一种用来解决**读 - 写冲突**的无所并发控制，也就是为事务分配单向增长的时间戳，为每一个修改保存一个版本，版本与事务时间戳关联，读操作只读该事务开始前的数据库的快照。

这样在读操作不用阻塞操作且写操作不用阻塞读操作的同时，避免了脏读和不可重复读。

**③一致性（Consistency）**
Elasticsearch 集群保证写一致性的方式是在写入前先检查有多少个分片可供写入，如果达到写入条件，则进行写操作，否则，Elasticsearch 会等待更多的分片出现，默认为一分钟。

有如下三种设置来判断是否允许写操作：

1. One：只要主分片可用，就可以进行写操作。

2. All：只有当主分片和所有副本都可用时，才允许写操作。

3. Quorum（k-wu-wo/reng，法定人数）：是 Elasticsearch 的默认选项。当有大部分的分片可用时才允许写操作。

   ```
   对 “大部分” 的计算公式为 
int ((primary+number_of_replicas)/2)+1。
   ```

Elasticsearch 集群保证读写一致性的方式是，为了保证搜索请求的返回结果是最新版本的文档，备份可以被设置为 **Sync（默认值**），写操作在主分片和备份分片同时完成后才会返回写请求的结果。

这样，无论搜索请求至哪个分片都会返回最新的文档。但是如果我们的应用对写要求很高，就可以通过设置 `replication=async `来提升写的效率，如果设置` replication=async`，则只要主分片的写完成，就会返回写成功。

**④脑裂**
在 Elasticsearch 集群中主节点通过 Ping 命令来检查集群中的其他节点是否处于可用状态，同时非主节点也会通过 Ping 来检查主节点是否处于可用状态。

当集群网络不稳定时，有可能会发生一个节点 Ping 不通 Master 节点，则会认为 Master 节点发生了故障，然后重新选出一个 Master 节点，这就会导致在一个集群内出现多个 Master 节点。

当在一个集群中有多个 Master 节点时，就有可能会导致数据丢失。我们称这种现象为脑裂。

**解决方案:**

1. 主节点和数据节点分离
2. 新增节点数为奇数,延迟ping响应时间
3. 控制参与判断的节点数量







参考:[掌握它才说明你真正懂 Elasticsearch - ES（三)](https://learnku.com/articles/40400)

[记一次生产环境 ES 脑裂](https://www.nosuchfield.com/2019/05/13/Production-environment-elasticsearch-split-brain/)

[Elasticsearch脑裂问题详细分析以及解决方案](https://blog.csdn.net/ichen820/article/details/107414528)

