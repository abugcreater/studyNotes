# 所有相关指令

```sh
PUT /customer/_doc/1
{
  "name":"over watch"
}

GET /customer/_doc/1

# 查询
GET /bank/_search
{
  "query":{"match_all": {}},
  "sort":[{"account_num":"asc"}]
}

# 分页查询

GET /bank/_search
{
  "from": 0,
  "size": 1,
  "query": { "match_all": {} },
  "sort": [
    { "account_number": "asc" }
  ]

}

#查询 注意body与url中不要有空行,否则body不生效
GET /bank/_search
{
  "query":{"match": {
     "address": "Columbus Place"
  }}
}

#段落查询 包含指定的值
GET /bank/_search
{
  "query": {"match_phrase": {
    "address": "Columbus Place"
  }}
}

#多条件查询
#搜索40岁客户的帐户，但不包括居住在爱达荷州（ID）的任何人
GET /bank/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "age": "40"
          }
        }
      ],
      "must_not": [
        {"match": {
          "state": "ID"
        }}
      ]
    }
  }
}

#同时使用query和filter查询
#query对数据进行打分,匹配越高,_score越好;filter只有两种结果匹配/不匹配,后者全部过滤
GET /bank/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "state": "ND"
          }
        }
      ],
      "filter": [
        {
          "term": {
            "age": "40"
          }
        },
        {
          "range": {
            "balance": {
              "gte": 20000,
              "lte": 30000
            }
          }
        }
      ]
    }
  }
}

# 只包含filter的查询语句 查询到的结果所有score值都为0
GET /bank/_search
{
  "query": {
    "bool": {
      "filter": [
        {
          "term": {
            "age": "40"
          }
        },
        {
          "range": {
            "balance": {
              "gte": 20000,
              "lte": 30000
            }
          }
        }
      ]
    }
  }
}

#聚合查询
##简单聚合 
##希望根据州统计梳理 使用aggs关键字对state字段聚合 被聚合的字段无需对分词统计，所以使用state.keyword对整个字段统计
GET /bank/_search
{
  "size": 0, //无需返回具体数据所有size=0
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state.keyword"
      }
    }
  }
}

##嵌套聚合
##在上述基础上在进行avg操作
GET /bank/_search
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state.keyword"
      },
      "aggs": {
        "average_balance": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}

##对查询结果排序
GET /bank/_search
{
  "size": 0,
  "aggs": {
    "group_by_state": {
      "terms": {
        "field": "state.keyword",
        "order": {
          "average_balance": "desc"
        }
      },
      "aggs": {
        "average_balance": {
          "avg": {
            "field": "balance"
          }
        }
      }
    }
  }
}

#查看索引
GET /bank


GET /_cat/indices?v


# 插入一个文档
PUT /customer/_doc/1
{
  "name": "John Doe"
}

#获取插入文档创建的index详情
GET /customer/_mapping
 
 
GET /customer/_search


#手动创建索引
PUT /test-index-users
{
  "settings": {
    "number_of_shards": 1,
    "number_of_replicas": 1
  },
  "mappings": {
    "properties": {
      "name":{
        "type": "text",
        "fields": {
          "keyword":{
            "type": "keyword",
            "ignore_above":256
          }
        }
      },
      "age":{
        "type": "long"
      },
      "remarks":{
        "type": "text"
      }
    }
  }  
}





POST /test-index-users/_doc
{
  "name":"xh test name",
  "age":18,
  "remarks":"no remarks"
}

GET /test-index-users/_search


POST /test-index-users/_doc
{
  "name":"xh test name",
  "age":"error age type",
  "remarks":"no remarks"
}


GET /_cat/indices?v&index=test-index-users


#修改索引
PUT /test-index-users/_settings
{
  "settings":{
    "number_of_replicas":0
  }
}


#关闭索引
POST /test-index-users/_close


POST /test-index-users/_doc
{
  "name":"xh test name2",
  "age":18,
  "remarks":"no remarks"
}

# 打开索引
POST /test-index-users/_open



#删除索引
DELETE /test-index-users

#查看索引 mapping
GET /bank/_mapping
#查看索引 setting
GET /bank/_settings



#创建模版
PUT _component_template/component_template1
{
  "template": {
    "mappings": {
      "properties": {
        "@timestamp": {
          "type": "date"
        }
      }
    }
  }
}

PUT _component_template/runtime_component_template
{
  "template": {
    "mappings": {
      "runtime": {
        "day_of_week": {
          "type": "keyword",
          "script": {
            "source": "emit(doc['@timestamp'].value.dayOfWeekEnum.getDisplayName(TextStyle.FULL, Locale.ROOT))"
          }
        }
      }
    }
  }
}


#创建使用组件模版的索引模版
PUT _index_template/template_1
{
  "index_patterns": [
    "bar*"
  ],
  "template": {
    "settings": {
      "number_of_shards": 1
    },
    "mappings": {
      "_source": {
        "enabled": true
      },
      "properties": {
        "host_name": {
          "type": "keyword"
        },
        "created_at": {
          "type": "date",
          "format": "EEE MMM dd HH:mm:ss Z yyyy"
        }
      }
    },
    "aliases": {
      "mydata": {}
    }
  },
  "priority": 500,
  "composed_of": [
    "component_template1",
    "runtime_component_template"
  ],
  "version": 3,
  "_meta": {
    "description": "my custom"
  }
}

#创建一个匹配上述索引模版的索引
PUT /bar_test

#查看上述索引映射
GET /bar_test/_mapping


#模拟模版结果
POST _index_template/_simulate_index/bar_tbtb_test

#模拟组件模版结果
POST _index_template/_simulate/template_1


#模拟组件模板和自身模板结合后的结果
## 新建两个组件模版
PUT _component_template/ct1
{
  "template":{
    "settings":{
      "index.number_of_shards" : 2
    }
  }
}

PUT _component_template/ct2
{
  "template":{
    "settings":{
      "index.number_of_replicas":0
    },
    "mappings":{
      "properties":{
        "@timestamp":{
          "type":"date"
        }
      }
    }
  }
}

## 模拟在两个组件模版的基础上,添加自身模版的配置
POST _index_template/_simulate
{
  "index_patterns": ["my*"],
  "template":{
    "settings" : {
        "index.number_of_shards" : 3
    }
  },
  "composed_of":["ct1","ct2"]
}

#复合查询例子(bool)
GET bank/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "match": {
            "age": "40"
          }
        }
      ],
      "must_not": [
        {"match": {
          "state": "ID"
        }}
      ]
    }
  }
}




POST _search
{
  "query": {
    "bool" : {
      "must" : {
        "term" : { "user.id" : "kimchy" }
      },
      "filter": {
        "term" : { "tags" : "production" }
      },
      "must_not" : {
        "range" : {
          "age" : { "gte" : 10, "lte" : 20 }
        }
      },
      "should" : [
        { "term" : { "tags" : "env1" } },
        { "term" : { "tags" : "deployed" } }
      ],
      "minimum_should_match" : 1,
      "boost" : 1.0
    }
  }
}

GET bank/_search

GET bank/_search
{
  "query": {
    "bool": {
      "must": {
        "term": {
          "account_number": 20
        }
      }
    }
  }
}

GET bank/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "match": {
            "firstname": {
              "query": "Elinor",
              "_name": "first"
            }
          }
        },
        {
          "match": {
            "lastname": {
              "query": "Ratliff",
              "_name": "last"
            }
          }
        }
      ],
      "filter": [
        {
          "terms": {
            "account_number": [20,21],
            "_name": "check"
          }
        }
      ]
    }
  }
}
  

## boosting query(提高查询)
### 首先插入数据
POST test-dsl-boosting/_bulk
{ "index": { "_id": 1 }}
{ "content":"Apple Mac" }
{ "index": { "_id": 2 }}
{ "content":"Apple Fruit" }
{ "index": { "_id": 3 }}
{ "content":"Apple employee like Apple Pie and Apple Juice" }

### 查询案例
GET test-dsl-boosting/_search
{
  "query": {
    "boosting": {
      "positive": {
        "term": {
          "content": {
            "value": "apple"
          }
        }
      },
      "negative": {
        "term": {
          "content": {
            "value": "pie"
          }
        }
      },
      "negative_boost": 0.1
    }
  }
}

## 固定分数查询 constant_score
### 插入数据
POST /test-dsl-constant/_bulk
{ "index": { "_id": 1 }}
{ "content":"Apple Mac" }
{ "index": { "_id": 2 }}
{ "content":"Apple Fruit" }

### 固定分数查询
GET /test-dsl-constant/_search
{
  "query": {
    "constant_score": {
      "filter": {
        "term": {
          "content": "mac"
        }
      },
      "boost": 1.0
    }
  }
}

## 最佳匹配 dis_max
POST /test-dsl-dis-max/_bulk
{ "index": { "_id": 1 }}
{"title": "Quick brown rabbits","body":  "Brown rabbits are commonly seen."}
{ "index": { "_id": 2 }}
{"title": "Keeping pets healthy","body":  "My quick brown fox eats rabbits on a regular basis."}

###bool查询
GET /test-dsl-dis-max/_search
{
    "query": {
        "bool": {
            "should": [
                { "match": { "title": "Brown fox" }},
                { "match": { "body":  "Brown fox" }}
            ]
        }
    }
}

## 分离查询
GET /test-dsl-dis-max/_search
{
  "query": {
    "dis_max": {
      "tie_breaker": 0,
      "queries": [
        {
          "match": {
            "title": "brown fox"
          }
        },
        {
          "match": {
            "body": "brown fox"
          }
        }
      ]
    }
  }
}

## 函数查询
GET bank/_search
{
  "query": {
    "function_score": {
      "query": {"match_all": {}},
      "boost": 3,
      "random_score": {},
      "boost_mode": "multiply"
    }
  }
}

# 全文查询
##match
PUT /test-dsl-match
{ "settings": { "number_of_shards": 1 }} 

POST /test-dsl-match/_bulk
{ "index": { "_id": 1 }}
{ "title": "The quick brown fox" }
{ "index": { "_id": 2 }}
{ "title": "The quick brown fox jumps over the lazy dog" }
{ "index": { "_id": 3 }}
{ "title": "The quick brown fox jumps over the quick dog" }
{ "index": { "_id": 4 }}
{ "title": "Brown fox brown dog" }

GET /test-dsl-match/_search
{
  "query": {
    "match": {
      "title": "QUICK!"
    }
  }
}

### 多个
GET /test-dsl-match/_search
{
    "query": {
        "match": {
            "title": "BROWN DOG"
        }
    }
}

#### 等同于bool查询
GET /test-dsl-match/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "term": {
            "title": {
              "value": "brown"
            }
          }
        },
        {
          "term": {
            "title": {
              "value": "dog"
            }
          }
        }
      ]
    }
  }
}

### operator参数
GET /test-dsl-match/_search
{
  "query": {
    "match": {
      "title": {
        "query": "BROWN DOG",
        "operator": "or"
      }
    }
  }
}

GET /test-dsl-match/_search
{
  "query": {
    "bool": {
      "must": [
        {
          "term": {
            "title": {
              "value": "brown"
            }
          }
        },
        {
          "term": {
            "title": {
              "value": "dog"
            }
          }
        }
      ]
    }
  }
}

## 控制最小匹配数量
GET /test-dsl-match/_search
{
  "query": {
    "match": {
      "title": {
        "query": "quick brown dog",
        "minimum_should_match": "75%" 
      }
    }
  }
}

### 等同于
GET /test-dsl-match/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "term": {
            "title": {
              "value": "quick"
            }
          }
        },
        {
          "term": {
            "title": {
              "value": "brown"
            }
          }
        },
        {
          "term": {
            "title": {
              "value": "dog"
            }
          }
        }
      ],
      "minimum_should_match": 2
    }
  }
}

### match_pharse
GET /test-dsl-match/_search
{
  "query": {
    "match_phrase": {
      "title": "quick brown"
    }
  }
}

### **match_pharse_prefix**
GET /test-dsl-match/_search
{
  "query": {
    "match_phrase_prefix": {
      "title": "quick brown f"
    }
  }
}

### match_bool_prefix
GET /test-dsl-match/_search
{
  "query": {
    "match_bool_prefix": {
      "title": "quick brown f"
    }
  }
}

#### 相同语句

GET /test-dsl-match/_search
{
  "query": {
    "bool": {
      "should": [
        {
          "term": {
            "title": {
              "value": "quick"
            }
          }
        },
        {
          "term": {
            "title": {
              "value": "brown"
            }
          }
        },
        {
          "prefix": {
            "title": {
              "value": "f"
            }
          }
        }
      ]
    }
  }
}


### multi_match
GET bank/_search
{
  "query": {
    "multi_match": {
      "query": 18,
      "fields": ["age","*number"]
    }
  }
}

##query
###query_string
GET test-dsl-match/_search
{
  "query": {
    "query_string": {
      "default_field": "title",
      "query": "(lazy dog) OR (brown dog)"
    }
  }
}

### simple_query_string 
GET test-dsl-match/_search
{
  "query": {
    "simple_query_string": {
      "query": "\"over the\" + {lazy | quick} + dog",
      "fields": []
    }
  }
}

##interval
GET test-dsl-match/_search
{
  "query": {
    "intervals": {
      "title": {
        "all_of": {
          "ordered": true,
          "intervals": [
            {
              "match": {
                "query": "quick",
                "max_gaps": 0,
                "ordered": true
              }
            },
            {
              "any_of": {
                "intervals": [
                  {
                    "match": {
                      "query": "jump over"
                    }
                  },
                  {
                    "match": {
                      "query": "quick dog"
                    }
                  }
                ]
              }
            }
          ]
        }
      }
    }
  }
}

#term查询
##准备数据
PUT /test-dsl-term-level
{
  "mappings": {
    "properties": {
      "name": {
        "type": "keyword"
      },
      "programming_languages": {
        "type": "keyword"
      },
      "required_matches": {
        "type": "long"
      }
    }
  }
}

POST /test-dsl-term-level/_bulk
{ "index": { "_id": 1 }}
{"name": "Jane Smith", "programming_languages": [ "c++", "java" ], "required_matches": 2}
{ "index": { "_id": 2 }}
{"name": "Jason Response", "programming_languages": [ "java", "php" ], "required_matches": 2}
{ "index": { "_id": 3 }}
{"name": "Dave Pdai", "programming_languages": [ "java", "c++", "php" ], "required_matches": 3, "remarks": "hello world"}


##exists
GET /test-dsl-term-level/_search
{
  "query": {
    "exists": {
      "field": "remarks"
    }
  }
}

##ids
GET /test-dsl-term-level/_search
{
  "query": {
    "ids": {
      "values": [1,3]
    }
  }
}

##prefix
GET /test-dsl-term-level/_search
{
  "query": {
    "prefix": {
      "name": {
        "value": "Jan"
      }
    }
  }
}

##term
GET /test-dsl-term-level/_search
{
  "query": {
    "term": {
      "programming_languages": {
        "value": "php"
      }
    }
  }
}

## terms
GET /test-dsl-term-level/_search
{
  "query": {
    "terms": {
      "programming_languages": [
        "php",
        "c++"
      ]
    }
  }
}

##term set
GET test-dsl-term-level/_search
{
  "query": {
    "terms_set": {
      "programming_languages": {
        "terms": [
          "php",
          "java"
        ],
        "minimum_should_match_field": "required_matches"
      }
    }
  }
}
## wildcard 通配符
GET test-dsl-term-level/_search
{
  "query": {
    "wildcard": {
      "name": {
        "value": "J*",
        "boost": 1,
        "rewrite": "constant_score"
      }
    }
  }
}

## range
GET test-dsl-term-level/_search
{
  "query": {
    "range": {
      "required_matches": {
        "gte": 1,
        "lte": 2
      }
    }
  }
}

##regexp 正则匹配
GET test-dsl-term-level/_search
{
  "query": {
    "regexp": {
      "name": {
        "value": "ja.*",
        "case_insensitive":true
      }
    }
  }
}

#fuzzy 模糊匹配
GET test-dsl-term-level/_search
{
  "query": {
    "fuzzy": {
      "remarks": {
        "value": "hello1"
      }
    }
  }
}


#聚合
## 桶聚合
### 知识点学习
#### 准备数据
POST /test-agg-cars/_bulk
{ "index": {}}
{ "price" : 10000, "color" : "red", "make" : "honda", "sold" : "2014-10-28" }
{ "index": {}}
{ "price" : 20000, "color" : "red", "make" : "honda", "sold" : "2014-11-05" }
{ "index": {}}
{ "price" : 30000, "color" : "green", "make" : "ford", "sold" : "2014-05-18" }
{ "index": {}}
{ "price" : 15000, "color" : "blue", "make" : "toyota", "sold" : "2014-07-02" }
{ "index": {}}
{ "price" : 12000, "color" : "green", "make" : "toyota", "sold" : "2014-08-19" }
{ "index": {}}
{ "price" : 20000, "color" : "red", "make" : "honda", "sold" : "2014-11-05" }
{ "index": {}}
{ "price" : 80000, "color" : "red", "make" : "bmw", "sold" : "2014-01-01" }
{ "index": {}}
{ "price" : 25000, "color" : "blue", "make" : "ford", "sold" : "2014-02-12" }

####  terms 桶操作聚合,获取个颜色汽车销量
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "popular_colors": {
      "terms": {
        "field": "color.keyword"
      }
    }
  }
}

#### 多个聚合,多个字段
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "popular_colors": {
      "terms": {
        "field": "color.keyword"
      }
    },
    "make_by":{
      "terms": {
        "field": "make.keyword"
      }
    }
  }
}

#### 聚合嵌套
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "colors": {
      "terms": {
        "field": "color.keyword"
      },
      "aggs": {
        "prices": {
          "avg": {
            "field": "price"
          }
        }
      }
    }
  }
}

#### 动态脚本聚合
GET /test-agg-cars/_search
{
  "runtime_mappings":{
    "make.length":{
      "type":"long",
      "script":"emit(doc['make.keyword'].value.length())"
    }
  },
  "size": 0,
  "aggs": {
    "make_length": {
      "histogram": {
        "field": "make.length",
        "interval": 1
      }
    }
  }
}

### 按知识点学习桶聚合
#### 前置条件过滤:filter
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "make_by": {
      "filter": {
        "term": {
          "make": "honda"
        }
      },
      "aggs": {
        "avg_prices": {
          "avg": {
            "field": "price"
          }
        }
      }
    }
  }
}

#### 对filter进行分组聚合
PUT /test-agg-logs/_bulk?refresh
{ "index" : { "_id" : 1 } }
{ "body" : "warning: page could not be rendered" }
{ "index" : { "_id" : 2 } }
{ "body" : "authentication error" }
{ "index" : { "_id" : 3 } }
{ "body" : "warning: connection timed out" }
{ "index" : { "_id" : 4 } }
{ "body" : "info: hello pdai" }

##### 对不同类型进行分组
GET /test-agg-logs/_search
{ 
  "size": 0, 
  "aggs": {
    "messages": {
      "filters": {
        "other_bucket_key": "other_message", 
        "filters": {
          "infos": {"match":{"body":"info"}},
          "warnings":{"match":{"body":"warning"}}
        }
      }
    }
  }
}

#### 对number聚合
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "avg_price": {
      "range": {
        "field": "price",
        "ranges": [
          {
            "to": 2000
          },
          {
            "from": 2000,
            "to": 40000
          },
          {
            "from": 40000
          }
        ]
      }
    }
  }
}

#### 根据日期聚合
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "range": {
      "date_range": {
        "field": "sold",
        "format": "yyyy-MM-dd",
        "ranges": [
          {
            "from": "2014-01-01"
          },
          {
            "to": "2014-12-31"
          }
        ]
      }
    }
  }
}

#### Histrogram 柱状图功能
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "price": {
      "histogram": {
        "field": "price",
        "interval": 20000
      },
      "aggs": {
        "sum_num": {
          "sum": {
            "field": "price"
          }
        }
      }
    }
  }
}


#### 拓展
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "makers": {
      "terms": {
        "field": "make.keyword",
        "size": 10
      },
      "aggs": {
        "stats": {
          "extended_stats": {
            "field": "price"
          }
        }
      }
    }
  }
}

##Metric聚合
### 单值分析 标准stat
#### avg平均值
GET /test-agg-cars/_search
{
  "size": 0, 
  "aggs": {
    "avg_price": {
      "avg": {
        "field": "price"
      }
    }
  }
}

#### max最大值
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "max_price": {
      "max": {
        "field": "price"
      }
    }
  }
}

#### sum综合
GET /test-agg-cars/_search
{
  "size": 0,
  "query": {
    "constant_score": {
      "filter": {
        "match": {
          "make": "honda"
        }
      }
    }
  },
  "aggs": {
    "sum_price": {
      "sum": {
        "field": "price"
      }
    }
  }
}

#### value_count 数量
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "count_make": {
      "value_count": {
        "field": "price"
      }
    }
  }
}

### 单值分析 其他类型
#### weighted_avg 带权重的avg
GET /bank/_search
{
  "size": 0,
  "aggs": {
    "weight_age": {
      "weighted_avg": {
        "value":{
          "field":"age"
        },
        "weight":{
          "field":"account_number"
        }
      }
    }
  }
}

#### median_absolute_deviation 中位值
GET /test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "review_average": {
      "avg": {
        "field": "price"
      }
    },
    "review_price": {
      "median_absolute_deviation": {
        "field": "price"
      }
    }
  }
}

POST /test-agg-cars/_search?size=0
{
  "aggs": {
    "grade_stats": {
      "stats": {
        "field": "price"
      }
    }
  }
}


GET bank/_search
{
  "size": 0, 
  "aggs": {
    "statistics": {
      "matrix_stats": {
        "fields": [ "age", "account_number" ]
      }
    }
  }
}

#### percentiles 百分数范围
GET test-agg-cars/_search
{
  "size": 0,
  "aggs": {
    "price_percent": {
      "percentiles": {
        "field": "price",
        "percents": [
          1,
          99
        ]
      }
    }
  }
}

GET bank/_search
  
  
### 非单值分析 top型
#### 分桶后top hits
GET /bank/_search
{
  "size": 0, 
  "aggs": {
    "top_make": {
      "terms": {
        "field": "balance",
        "size": 3
      },
      "aggs": {
        "top_sale_hit": {
          "top_hits": {
            "sort": [
              {
                "account_number": {
                  "order": "desc"
                }
              }
            ],
            "_source": {
              "includes": [
                "account_number",
                "age",
                "balance"
              ]
            },
            "size": 10
          }
        }
      }
    }
  }
}

#### top_metrics
POST /test_top_metrics/_bulk?refresh
{"index": {}}
{"s": 1, "m": 3.1415}
{"index": {}}
{"s": 2, "m": 1.0}
{"index": {}}
{"s": 3, "m": 2.71828}

POST test_top_metrics/_search?filter_path=aggregations
{
  "aggs": {
    "tm": {
      "top_metrics": {
        "metrics": {"field": "m"},
        "sort": {"s": "desc"}
      }
    }
  }
}


POST _search
{
  "size": 0,
  "aggs": {
    "sales_per_month": {
      "date_histogram": {
        "field": "date",
        "calendar_interval": "month"
      },
      "aggs": {
        "sales": {
          "sum": {
            "field": "price"
          }
        }
      }
    },
    "avg_monthly_sales": {
      "avg_bucket": {
        "buckets_path": "sales_per_month>sales",
        "gap_policy": "skip",
        "format": "#,##0.00;(#,##0.00)"
      }
    }
  }
}
```

